$(function () {
	
    
       




	var App = window.tobiz;
        window.tobiz.editor = true;
        
	App.userBlocks = new Array();
        
        
        
        
        App.blocksDefaultPositions = {};
        _.each(App.sections, function(o,i){
            _.each(o.blocks, function(block,index){
                if(block['default']==1){
                    App.blocksDefaultPositions[block.id] = block.position;
                }
            })
            _.each(o.deleted, function(block){
                App.blocksDefaultPositions[block] = o.blocks[0].position;
            })
        })        
        
	sortableSection = function(){
		$('#wrapper').sortable({
			placeholder: "ui-state-highlight",
			handle: "[data-move]",
			axis: "y"
		});                 
	}
	
	App.events = {
            beforeBlockRender: function(){},
            afterBlockRender: function(id){
                var userBlock = _.findWhere(App.userBlocks, {id: id});
                setTimeout(function(){
                    if(userBlock.type_id==312){
                        App.slider312Init(id);
                    }
                    if(userBlock.type_id==126){
                        App.slider126Init(id);
                    }                    
                    if(userBlock.type_id==151){
                        App.slider151Init(id);
                    }                    
                    if(userBlock.type_id==149){
                        App.slider149Init(id);
                    }                    
                    if(userBlock.type_id==118){
                        App.slider118Init(id);
                    }                    

                    $('#b_'+id).find('iframe').each(function(){
                        var src = $(this).attr('src');
                            if($(this).parents('.form_html, .html').size()){
                                return false;
                            }
                        if(src.indexOf('https://www.youtube.com/embed/')>-1){
                            var video_id = src.substring(30);
                            $(this).replaceWith('<div class="video_holder" data-video="'+$(this).attr('src')+'" style="width:'+$(this).width()+'px; height:'+$(this).height()+'px; background-image: url(https://i.ytimg.com/vi/'+video_id+'/maxresdefault.jpg);"></div>')
                        }                    
                    })
                
                }, 600)
                
                
            }
        }
        
        
	App.hexToRgb = function(hex) {
            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });

            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
	
	App.video_render = function(el){
	
				var ratio = 16/9;
	
				function resize() {
					var cWidth = Math.floor(el.width());
					var cHeight = Math.floor(el.outerHeight());
					var  pWidth = Math.floor($(window).width());
					if(pWidth<cWidth){
						pWidth = cWidth;
					}
					var pHeight = Math.floor(pWidth/ratio);
					if(pHeight<cHeight){
						pHeight = cHeight;
						pWidth = Math.floor(pHeight*ratio);
					}
					var  position_top = 0, 
						 position_left=0;
				 
					if((cHeight - pHeight)<0){
						position_top = Math.floor((cHeight - pHeight) / 2);
					}
					if((cWidth - pWidth)<0){
						position_left = Math.floor((cWidth - pWidth) / 2);
					}
					
					el.find('.video_bg').css({
							height: pHeight,
							width: pWidth,						
							left: position_left,
							top: position_top,
					});
				}
				resize();
				$(window).resize(function(){
					resize();
                                        
                                        
                                        
				})
	
	
	
	} 
        
        
        
        
	
	setInterval(function(){

		
	$('.section').each(function(){

		if($(this).find('.video_bg').size()){
			App.video_render($(this));

		}
		
		
		
	})		
		
		
		
	},1000);
	
	sortableSection();

	// иконки
	App.icons = ['fa-500px', 'fa-adjust', 'fa-adn', 'fa-align-center', 'fa-align-justify', 'fa-align-left', 'fa-align-right', 'fa-amazon', 'fa-ambulance', 'fa-anchor', 'fa-android', 'fa-angellist', 'fa-angle-double-down', 'fa-angle-double-left', 'fa-angle-double-right', 'fa-angle-double-up', 'fa-angle-down', 'fa-angle-left', 'fa-angle-right', 'fa-angle-up', 'fa-apple', 'fa-archive', 'fa-area-chart', 'fa-arrow-circle-down', 'fa-arrow-circle-left', 'fa-arrow-circle-o-down', 'fa-arrow-circle-o-left', 'fa-arrow-circle-o-right', 'fa-arrow-circle-o-up', 'fa-arrow-circle-right', 'fa-arrow-circle-up', 'fa-arrow-down', 'fa-arrow-left', 'fa-arrow-right', 'fa-arrow-up', 'fa-arrows', 'fa-arrows-alt', 'fa-arrows-h', 'fa-arrows-v', 'fa-asterisk', 'fa-at', 'fa-automobile', 'fa-backward', 'fa-balance-scale', 'fa-ban', 'fa-bank', 'fa-bar-chart', 'fa-bar-chart-o', 'fa-barcode', 'fa-bars', 'fa-battery-0', 'fa-battery-1', 'fa-battery-2', 'fa-battery-3', 'fa-battery-4', 'fa-battery-empty', 'fa-battery-full', 'fa-battery-half', 'fa-battery-quarter', 'fa-battery-three-quarters', 'fa-bed', 'fa-beer', 'fa-behance', 'fa-behance-square', 'fa-bell', 'fa-bell-o', 'fa-bell-slash', 'fa-bell-slash-o', 'fa-bicycle', 'fa-binoculars', 'fa-birthday-cake', 'fa-bitbucket', 'fa-bitbucket-square', 'fa-bitcoin', 'fa-black-tie', 'fa-bold', 'fa-bolt', 'fa-bomb', 'fa-book', 'fa-bookmark', 'fa-bookmark-o', 'fa-briefcase', 'fa-btc', 'fa-bug', 'fa-building', 'fa-building-o', 'fa-bullhorn', 'fa-bullseye', 'fa-bus', 'fa-buysellads', 'fa-cab', 'fa-calculator', 'fa-calendar', 'fa-calendar-check-o', 'fa-calendar-minus-o', 'fa-calendar-o', 'fa-calendar-plus-o', 'fa-calendar-times-o', 'fa-camera', 'fa-camera-retro', 'fa-car', 'fa-caret-down', 'fa-caret-left', 'fa-caret-right', 'fa-caret-square-o-down', 'fa-caret-square-o-left', 'fa-caret-square-o-right', 'fa-caret-square-o-up', 'fa-caret-up', 'fa-cart-arrow-down', 'fa-cart-plus', 'fa-cc', 'fa-cc-amex', 'fa-cc-diners-club', 'fa-cc-discover', 'fa-cc-jcb', 'fa-cc-mastercard', 'fa-cc-paypal', 'fa-cc-stripe', 'fa-cc-visa', 'fa-certificate', 'fa-chain', 'fa-chain-broken', 'fa-check', 'fa-check-circle', 'fa-check-circle-o', 'fa-check-square', 'fa-check-square-o', 'fa-chevron-circle-down', 'fa-chevron-circle-left', 'fa-chevron-circle-right', 'fa-chevron-circle-up', 'fa-chevron-down', 'fa-chevron-left', 'fa-chevron-right', 'fa-chevron-up', 'fa-child', 'fa-chrome', 'fa-circle', 'fa-circle-o', 'fa-circle-o-notch', 'fa-circle-thin', 'fa-clipboard', 'fa-clock-o', 'fa-clone', 'fa-close', 'fa-cloud', 'fa-cloud-download', 'fa-cloud-upload', 'fa-cny', 'fa-code', 'fa-code-fork', 'fa-codepen', 'fa-coffee', 'fa-cog', 'fa-cogs', 'fa-columns', 'fa-comment', 'fa-comment-o', 'fa-commenting', 'fa-commenting-o', 'fa-comments', 'fa-comments-o', 'fa-compass', 'fa-compress', 'fa-connectdevelop', 'fa-contao', 'fa-copy', 'fa-copyright', 'fa-creative-commons', 'fa-credit-card', 'fa-crop', 'fa-crosshairs', 'fa-css3', 'fa-cube', 'fa-cubes', 'fa-cut', 'fa-cutlery', 'fa-dashboard', 'fa-dashcube', 'fa-database', 'fa-dedent', 'fa-delicious', 'fa-desktop', 'fa-deviantart', 'fa-diamond', 'fa-digg', 'fa-dollar', 'fa-dot-circle-o', 'fa-download', 'fa-dribbble', 'fa-dropbox', 'fa-drupal', 'fa-edit', 'fa-eject', 'fa-ellipsis-h', 'fa-ellipsis-v', 'fa-empire', 'fa-envelope', 'fa-envelope-o', 'fa-envelope-square', 'fa-eraser', 'fa-eur', 'fa-euro', 'fa-exchange', 'fa-exclamation', 'fa-exclamation-circle', 'fa-exclamation-triangle', 'fa-expand', 'fa-expeditedssl', 'fa-external-link', 'fa-external-link-square', 'fa-eye', 'fa-eye-slash', 'fa-eyedropper', 'fa-facebook', 'fa-facebook-f', 'fa-facebook-official', 'fa-facebook-square', 'fa-fast-backward', 'fa-fast-forward', 'fa-fax', 'fa-feed', 'fa-female', 'fa-fighter-jet', 'fa-file', 'fa-file-archive-o', 'fa-file-audio-o', 'fa-file-code-o', 'fa-file-excel-o', 'fa-file-image-o', 'fa-file-movie-o', 'fa-file-o', 'fa-file-pdf-o', 'fa-file-photo-o', 'fa-file-picture-o', 'fa-file-powerpoint-o', 'fa-file-sound-o', 'fa-file-text', 'fa-file-text-o', 'fa-file-video-o', 'fa-file-word-o', 'fa-file-zip-o', 'fa-files-o', 'fa-film', 'fa-filter', 'fa-fire', 'fa-fire-extinguisher', 'fa-firefox', 'fa-flag', 'fa-flag-checkered', 'fa-flag-o', 'fa-flash', 'fa-flask', 'fa-flickr', 'fa-floppy-o', 'fa-folder', 'fa-folder-o', 'fa-folder-open', 'fa-folder-open-o', 'fa-font', 'fa-fonticons', 'fa-forumbee', 'fa-forward', 'fa-foursquare', 'fa-frown-o', 'fa-futbol-o', 'fa-gamepad', 'fa-gavel', 'fa-gbp', 'fa-ge', 'fa-gear', 'fa-gears', 'fa-genderless', 'fa-get-pocket', 'fa-gg', 'fa-gg-circle', 'fa-gift', 'fa-git', 'fa-git-square', 'fa-github', 'fa-github-alt', 'fa-github-square', 'fa-gittip', 'fa-glass', 'fa-globe', 'fa-google', 'fa-google-plus', 'fa-google-plus-square', 'fa-google-wallet', 'fa-graduation-cap', 'fa-gratipay', 'fa-group', 'fa-h-square', 'fa-hacker-news', 'fa-hand-grab-o', 'fa-hand-lizard-o', 'fa-hand-o-down', 'fa-hand-o-left', 'fa-hand-o-right', 'fa-hand-o-up', 'fa-hand-paper-o', 'fa-hand-peace-o', 'fa-hand-pointer-o', 'fa-hand-rock-o', 'fa-hand-scissors-o', 'fa-hand-spock-o', 'fa-hand-stop-o', 'fa-hdd-o', 'fa-header', 'fa-headphones', 'fa-heart', 'fa-heart-o', 'fa-heartbeat', 'fa-history', 'fa-home', 'fa-hospital-o', 'fa-hotel', 'fa-hourglass', 'fa-hourglass-1', 'fa-hourglass-2', 'fa-hourglass-3', 'fa-hourglass-end', 'fa-hourglass-half', 'fa-hourglass-o', 'fa-hourglass-start', 'fa-houzz', 'fa-html5', 'fa-i-cursor', 'fa-ils', 'fa-image', 'fa-inbox', 'fa-indent', 'fa-industry', 'fa-info', 'fa-info-circle', 'fa-inr', 'fa-instagram', 'fa-institution', 'fa-internet-explorer', 'fa-intersex', 'fa-ioxhost', 'fa-italic', 'fa-joomla', 'fa-jpy', 'fa-jsfiddle', 'fa-key', 'fa-keyboard-o', 'fa-krw', 'fa-language', 'fa-laptop', 'fa-lastfm', 'fa-lastfm-square', 'fa-leaf', 'fa-leanpub', 'fa-legal', 'fa-lemon-o', 'fa-level-down', 'fa-level-up', 'fa-life-bouy', 'fa-life-buoy', 'fa-life-ring', 'fa-life-saver', 'fa-lightbulb-o', 'fa-line-chart', 'fa-link', 'fa-linkedin', 'fa-linkedin-square', 'fa-linux', 'fa-list', 'fa-list-alt', 'fa-list-ol', 'fa-list-ul', 'fa-location-arrow', 'fa-lock', 'fa-long-arrow-down', 'fa-long-arrow-left', 'fa-long-arrow-right', 'fa-long-arrow-up', 'fa-magic', 'fa-magnet', 'fa-mail-forward', 'fa-mail-reply', 'fa-mail-reply-all', 'fa-male', 'fa-map', 'fa-map-marker', 'fa-map-o', 'fa-map-pin', 'fa-map-signs', 'fa-mars', 'fa-mars-double', 'fa-mars-stroke', 'fa-mars-stroke-h', 'fa-mars-stroke-v', 'fa-maxcdn', 'fa-meanpath', 'fa-medium', 'fa-medkit', 'fa-meh-o', 'fa-mercury', 'fa-microphone', 'fa-microphone-slash', 'fa-minus', 'fa-minus-circle', 'fa-minus-square', 'fa-minus-square-o', 'fa-mobile', 'fa-mobile-phone', 'fa-money', 'fa-moon-o', 'fa-mortar-board', 'fa-motorcycle', 'fa-mouse-pointer', 'fa-music', 'fa-navicon', 'fa-neuter', 'fa-newspaper-o', 'fa-object-group', 'fa-object-ungroup', 'fa-odnoklassniki', 'fa-odnoklassniki-square', 'fa-opencart', 'fa-openid', 'fa-opera', 'fa-optin-monster', 'fa-outdent', 'fa-pagelines', 'fa-paint-brush', 'fa-paper-plane', 'fa-paper-plane-o', 'fa-paperclip', 'fa-paragraph', 'fa-paste', 'fa-pause', 'fa-paw', 'fa-paypal', 'fa-pencil', 'fa-pencil-square', 'fa-pencil-square-o', 'fa-phone', 'fa-phone-square', 'fa-photo', 'fa-picture-o', 'fa-pie-chart', 'fa-pied-piper', 'fa-pied-piper-alt', 'fa-pinterest', 'fa-pinterest-p', 'fa-pinterest-square', 'fa-plane', 'fa-play', 'fa-play-circle', 'fa-play-circle-o', 'fa-plug', 'fa-plus', 'fa-plus-circle', 'fa-plus-square', 'fa-plus-square-o', 'fa-power-off', 'fa-print', 'fa-puzzle-piece', 'fa-qq', 'fa-qrcode', 'fa-question', 'fa-question-circle', 'fa-quote-left', 'fa-quote-right', 'fa-ra', 'fa-random', 'fa-rebel', 'fa-recycle', 'fa-reddit', 'fa-reddit-square', 'fa-refresh', 'fa-registered', 'fa-remove', 'fa-renren', 'fa-reorder', 'fa-repeat', 'fa-reply', 'fa-reply-all', 'fa-retweet', 'fa-rmb', 'fa-road', 'fa-rocket', 'fa-rotate-left', 'fa-rotate-right', 'fa-rouble', 'fa-rss', 'fa-rss-square', 'fa-rub', 'fa-ruble', 'fa-rupee', 'fa-safari', 'fa-save', 'fa-scissors', 'fa-search', 'fa-search-minus', 'fa-search-plus', 'fa-sellsy', 'fa-send', 'fa-send-o', 'fa-server', 'fa-share', 'fa-share-alt', 'fa-share-alt-square', 'fa-share-square', 'fa-share-square-o', 'fa-shekel', 'fa-sheqel', 'fa-shield', 'fa-ship', 'fa-shirtsinbulk', 'fa-shopping-cart', 'fa-sign-in', 'fa-sign-out', 'fa-signal', 'fa-simplybuilt', 'fa-sitemap', 'fa-skyatlas', 'fa-skype', 'fa-slack', 'fa-sliders', 'fa-slideshare', 'fa-smile-o', 'fa-soccer-ball-o', 'fa-sort', 'fa-sort-alpha-asc', 'fa-sort-alpha-desc', 'fa-sort-amount-asc', 'fa-sort-amount-desc', 'fa-sort-asc', 'fa-sort-desc', 'fa-sort-down', 'fa-sort-numeric-asc', 'fa-sort-numeric-desc', 'fa-sort-up', 'fa-soundcloud', 'fa-space-shuttle', 'fa-spinner', 'fa-spoon', 'fa-spotify', 'fa-square', 'fa-square-o', 'fa-stack-exchange', 'fa-stack-overflow', 'fa-star', 'fa-star-half', 'fa-star-half-empty', 'fa-star-half-full', 'fa-star-half-o', 'fa-star-o', 'fa-steam', 'fa-steam-square', 'fa-step-backward', 'fa-step-forward', 'fa-stethoscope', 'fa-sticky-note', 'fa-sticky-note-o', 'fa-stop', 'fa-street-view', 'fa-strikethrough', 'fa-stumbleupon', 'fa-stumbleupon-circle', 'fa-subscript', 'fa-subway', 'fa-suitcase', 'fa-sun-o', 'fa-superscript', 'fa-support', 'fa-table', 'fa-tablet', 'fa-tachometer', 'fa-tag', 'fa-tags', 'fa-tasks', 'fa-taxi', 'fa-television', 'fa-tencent-weibo', 'fa-terminal', 'fa-text-height', 'fa-text-width', 'fa-th', 'fa-th-large', 'fa-th-list', 'fa-thumb-tack', 'fa-thumbs-down', 'fa-thumbs-o-down', 'fa-thumbs-o-up', 'fa-thumbs-up', 'fa-ticket', 'fa-times', 'fa-times-circle', 'fa-times-circle-o', 'fa-tint', 'fa-toggle-down', 'fa-toggle-left', 'fa-toggle-off', 'fa-toggle-on', 'fa-toggle-right', 'fa-toggle-up', 'fa-trademark', 'fa-train', 'fa-transgender', 'fa-transgender-alt', 'fa-trash', 'fa-trash-o', 'fa-tree', 'fa-trello', 'fa-tripadvisor', 'fa-trophy', 'fa-truck', 'fa-try', 'fa-tty', 'fa-tumblr', 'fa-tumblr-square', 'fa-turkish-lira', 'fa-tv', 'fa-twitch', 'fa-twitter', 'fa-twitter-square', 'fa-umbrella', 'fa-underline', 'fa-undo', 'fa-university', 'fa-unlink', 'fa-unlock', 'fa-unlock-alt', 'fa-unsorted', 'fa-upload', 'fa-usd', 'fa-user', 'fa-user-md', 'fa-user-plus', 'fa-user-secret', 'fa-user-times', 'fa-users', 'fa-venus', 'fa-venus-double', 'fa-venus-mars', 'fa-viacoin', 'fa-video-camera', 'fa-vimeo', 'fa-vimeo-square', 'fa-vine', 'fa-vk', 'fa-volume-down', 'fa-volume-off', 'fa-volume-up', 'fa-warning', 'fa-wechat', 'fa-weibo', 'fa-weixin', 'fa-whatsapp', 'fa-wheelchair', 'fa-wifi', 'fa-wikipedia-w', 'fa-windows', 'fa-won', 'fa-wordpress', 'fa-wrench', 'fa-xing', 'fa-xing-square', 'fa-y-combinator', 'fa-y-combinator-square', 'fa-yahoo', 'fa-yc', 'fa-yc-square', 'fa-yelp', 'fa-yen', 'fa-youtube', 'fa-youtube-play', 'fa-youtube-square'];
	App.cicons = ['anchor.png', 'aperture.png', 'arrow-down.png', 'arrow-up.png', 'art.png', 'barchart.png', 'batteryfull.png', 'batterylow.png', 'bike.png', 'biker.png', 'bikewheel.png', 'blimp.png', 'bolt.png', 'bomb.png', 'booklet.png', 'Bookmark.png', 'bookshelf.png', 'briefcase.png', 'brightness.png', 'browser.png', 'brush-pencil.png', 'calculator.png', 'calendar.png', 'camera.png', 'car.png', 'cart.png', 'carwheel.png', 'caution.png', 'Chart.png', 'chat.png', 'check.png', 'circlecompass.png', 'clapboard.png', 'clipboard.png', 'clock.png', 'cloud.png', 'cmyk.png', 'colorwheel.png', 'Comment.png', 'compass.png', 'compose.png', 'computer.png', 'cone.png', 'contacts.png', 'contrast.png', 'countdown.png', 'creditcard.png', 'crop.png', 'crossroads.png', 'cruise.png', 'cursor.png', 'Dashboard.png', 'Database.png', 'denied.png', 'dev.png', 'die.png', 'document.png', 'dolly.png', 'door.png', 'download.png', 'easel.png', 'email.png', 'eyedropper.png', 'eye.png', 'fashion.png', 'filmreel.png', 'filmroll.png', 'flag.png', 'flame.png', 'flash.png', 'flower.png', 'focus.png', 'folder.png', 'frames.png', 'gamecontroller.png', 'gas.png', 'gear.png', 'genius.png', 'Gift.png', 'global.png', 'globe.png', 'gps.png', 'hazard.png', 'heart.png', 'helicopter.png', 'Home.png', 'hotair.png', 'hourglass.png', 'image.png', 'interstate.png', 'keyboard.png', 'key.png', 'lens.png', 'lightbulb.png', 'loading.png', 'location.png', 'locked.png', 'Lock.png', 'magicwand.png', 'magnifyingglass.png', 'Mail3.png', 'mail.png', 'map.png', 'megaphone2.png', 'megaphone.png', 'memorycard.png', 'merge.png', 'mic.png', 'microphone.png', 'money.png', 'motorcycle.png', 'music.png', 'news.png', 'paintbrush2.png', 'paintbrush.png', 'paintcan.png', 'paintroller.png', 'parachute.png', 'pencil.png', 'phone.png', 'Picture.png', 'pie-chart.png', 'pin2.png', 'pin.png', 'plane.png', 'play.png', 'plugin.png', 'polaroidcamera.png', 'polaroid.png', 'polaroids.png', 'power.png', 'present.png', 'Printer.png', 'profle.png', 'quote.png', 'racingflags.png', 'radio.png', 'radiotower.png', 'rainbow.png', 'recycle.png', 'rgb.png', 'ribbon.png', 'roadblock.png', 'rocket.png', 'RoundIcons-Free-Set-01.png', 'RoundIcons-Free-Set-02.png', 'RoundIcons-Free-Set-03.png', 'RoundIcons-Free-Set-04.png', 'RoundIcons-Free-Set-05.png', 'RoundIcons-Free-Set-06.png', 'RoundIcons-Free-Set-07.png', 'RoundIcons-Free-Set-08.png', 'RoundIcons-Free-Set-09.png', 'RoundIcons-Free-Set-10.png', 'RoundIcons-Free-Set-11.png', 'RoundIcons-Free-Set-12.png', 'RoundIcons-Free-Set-13.png', 'RoundIcons-Free-Set-14.png', 'RoundIcons-Free-Set-15.png', 'RoundIcons-Free-Set-16.png', 'RoundIcons-Free-Set-17.png', 'RoundIcons-Free-Set-18.png', 'RoundIcons-Free-Set-19.png', 'RoundIcons-Free-Set-20.png', 'RoundIcons-Free-Set-21.png', 'RoundIcons-Free-Set-22.png', 'RoundIcons-Free-Set-23.png', 'RoundIcons-Free-Set-24.png', 'RoundIcons-Free-Set-25.png', 'RoundIcons-Free-Set-26.png', 'RoundIcons-Free-Set-27.png', 'RoundIcons-Free-Set-28.png', 'RoundIcons-Free-Set-29.png', 'RoundIcons-Free-Set-30.png', 'RoundIcons-Free-Set-31.png', 'RoundIcons-Free-Set-32.png', 'RoundIcons-Free-Set-33.png', 'RoundIcons-Free-Set-34.png', 'RoundIcons-Free-Set-35.png', 'RoundIcons-Free-Set-36.png', 'RoundIcons-Free-Set-37.png', 'RoundIcons-Free-Set-38.png', 'RoundIcons-Free-Set-39.png', 'RoundIcons-Free-Set-40.png', 'RoundIcons-Free-Set-41.png', 'RoundIcons-Free-Set-42.png', 'RoundIcons-Free-Set-43.png', 'RoundIcons-Free-Set-44.png', 'RoundIcons-Free-Set-45.png', 'RoundIcons-Free-Set-46.png', 'RoundIcons-Free-Set-47.png', 'RoundIcons-Free-Set-48.png', 'RoundIcons-Free-Set-49.png', 'RoundIcons-Free-Set-50.png', 'RoundIcons-Free-Set-51.png', 'RoundIcons-Free-Set-52.png', 'RoundIcons-Free-Set-53.png', 'RoundIcons-Free-Set-54.png', 'RoundIcons-Free-Set-55.png', 'RoundIcons-Free-Set-56.png', 'RoundIcons-Free-Set-57.png', 'RoundIcons-Free-Set-58.png', 'RoundIcons-Free-Set-59.png', 'RoundIcons-Free-Set-60.png', 'rulertriangle.png', 'running.png', 'sailboat.png', 'schooolbus.png', 'scissors.png', 'scooter.png', 'Search.png', 'security.png', 'selftimer.png', 'settings.png', 'shipwheel.png', 'shoeprints.png', 'Shopping.png', 'shop.png', 'skateboard.png', 'slr.png', 'smartphone.png', 'spaceshuttle.png', 'speaker.png', 'speedometer.png', 'spraypaint.png', 'stack.png', 'star.png', 'steeringwheel.png', 'stop.png', 'submarine.png', 'sub.png', 'support.png', 'swatches.png', 'tablet.png', 'Tag.png', 'takeoff.png', 'target.png', 'taxi.png', 'Thumb_Up.png', 'toolbox.png', 'tools.png', 'tractor.png', 'traffic.png', 'train.png', 'travelerbag.png', 'trends.png', 'tripod.png', 'trophy.png', 'truck.png', 'T-Shirt.png', 'tv.png', 'Twitter.png', 'typography.png', 'ufo.png', 'umbrella.png', 'unicycle.png', 'unlocked.png', 'upload.png', 'User.png', 'videocameraclassic.png', 'videocameracompact.png', 'video.png', 'volume.png', 'water.png', 'weather.png', 'windsock.png', 'windy.png', 'x.png', 'zoomin.png', 'zoomout.png', 'my-check.png', 'my-close.png'];
	App.cicon_check_and_uncheck = ['my-check.png', 'my-close.png'];

        App.btn_styles = [
                    {id:1, title: 'Кнопка 1', css: '0.3em'},
                    {id:2, title: 'Кнопка 2', css: '0.5em'},
                    {id:3, title: 'Кнопка 3', css: '1em'},
                    {id:4, title: 'Кнопка 4', css: '1.5em'},
                    {id:5, title: 'Кнопка 5', css: '10em'},
                    {id:6, title: 'Кнопка 6', css: '5em 0 5em 0'},
                    {id:7, title: 'Кнопка 7', css: '5em 5em 0 0'},
                    {id:8, title: 'Кнопка 8', css: '0 0 5em 5em'},
                    {id:9, title: 'Кнопка 9', css: '30em 0 0 30em'},
                    {id:10, title: 'Кнопка 10', css: '0 30em 30em 0'},
                    {id:11, title: 'Кнопка 11', css: '0  30em  30em 30em'},
                    {id:12, title: 'Кнопка 12', css: '30em  0  30em 30em'},
                    {id:13, title: 'Кнопка 13', css: '30em  30em  0 30em'},
                    {id:14, title: 'Кнопка 14', css: '30em  30em  30em 0'},
                    {id:15, title: 'Кнопка 15', css: '30em  5em'},
                    {id:16, title: 'Кнопка 16', css: '5em  30em'},
                    {id:17, title: 'НЕТ', css: '0'},
                ];
        App.btn_shadows = [
                    {id:1, title: 'Тень 1', css: '0 0.3em 0.3em 0px rgba(0,0,0,0.4)'},
                    {id:2, title: 'Тень 2', css: '0 0.5em 0.3em 0px rgba(0,0,0,0.4)'},
                    {id:3, title: 'Тень 3', css: '0 0.3em 0px -1px rgba(0,0,0,0.4)'},
                    {id:4, title: 'Тень 4', css: '0.3em 0.3em 0.3em 0px rgba(0,0,0,0.4)'},

                    {id:5, title: 'НЕТ', css: '0'},
                ];
        App.fonts = [
            {
                title:'Arial',
                value:'Arial, sans-serif'
            },
            {
                title:'Helvetica',
                value:'Helvetica, sans-serif'
            },
            {
                title:'Comic Sans MS',
                value:'Comic Sans MS, cursive'
            },
            {
                title:'Courier New',
                value:'Courier New, Courier, monospace'
            },
            {
                title:'Georgia',
                value:'Georgia, serif'
            },
            {
                title:'Lucida Sans Unicode',
                value:'Lucida Sans Unicode, Lucida Grande, sans-serif'
            },
            {
                title:'Tahoma',
                value:'Tahoma, Geneva, sans-serif'
            },
            {
                title:'Times New Roman',
                value:'Times New Roman, Times, serif'
            },
            {
                title:'Trebuchet MS',
                value:'Trebuchet MS, Helvetica, sans-serif'
            },
            {
                title:'Verdana',
                value:'Verdana, Geneva, sans-serif'
            },
            {
                title:'Ubuntu',
                value:'Ubuntu, sans-serif'
            },
            {
                title:'Russo One',
                value:'Russo One, sans-serif'
            },
            {
                title:'Poiret One',
                value:'Poiret One, sans-serif'
            },
            {
                title:'Playfair Display SC',
                value:'Playfair Display SC, sans-serif'
            },
            {
                title:'Open Sans Condensed',
                value:'Open Sans Condensed, sans-serif'
            },
            {
                title:'Neucha',
                value:'Neucha, sans-serif'
            },
            {
                title:'Jura',
                value:'Jura, sans-serif'
            },
            {
                title:'Forum',
                value:'Forum, sans-serif'
            },
            {
                title:'Cormorant Infant',
                value:'Cormorant Infant, sans-serif'
            },
            {
                title:'Comfortaa',
                value:'Comfortaa, sans-serif'
            },
            {
                title:'PT Sans Narrow',
                value:'PT Sans Narrow, sans-serif'
            },
            {
                title:'PT Sans',
                value:'PT Sans, sans-serif'
            },
            {
                title:'Ruslan Display',
                value:'Ruslan Display, sans-serif'
            },
            {
                title:'Playfair Display SC',
                value:'Playfair Display SC, sans-serif'
            },
            {
                title:'Lobster',
                value:'Lobster, sans-serif'
            },
            {
                title:'EB Garamond',
                value:'EB Garamond, sans-serif'
            },
            {
                title:'Philosopher',
                value:'Philosopher, sans-serif'
            },
            {
                title:'Cormorant Garamond',
                value:'Cormorant Garamond, sans-serif'
            },
            {
                title:'Cormorant SC',
                value:'Cormorant SC, sans-serif'
            },
            {
                title:'Cormorant Unicase',
                value:'Cormorant Unicase, sans-serif'
            },
            {
                title:'El Messiri',
                value:'El Messiri, sans-serif'
            },

        ];




	_.mixin({
		
		cloneDeep: function(obj){
			return JSON.parse(JSON.stringify(obj));
		},
                
               
                

		
		videoId: function(link){
			// *?? not stabile
                        
                        if(typeof(link) != "undefined"){
                            var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;
                            var match = link.match(regExp);
                            return (match&&match[7].length==11)? match[7] : false;
                        }else{
                            return false;
                        }
		},
		
		stripTags: function(string){
			return string.replace(/(<([^>]+)>)/ig, '');
		},
		
		renderTimer: function(class_name, obj, color){
			
			return '<div class="'+class_name+'  objtimer" data-type="'+obj.type+'"\n\
												data-dd="'+obj.dd+'"\n\
												data-dm="'+obj.dm+'"\n\
												data-dy="'+obj.dy+'"\n\
												data-monthly="'+obj.monthly+'"\n\
												data-weekly="'+obj.weekly+'"\n\
												data-hr="'+obj.hr+'"\n\
												data-min="'+obj.min+'"\n\
						>\n\
						<div class="days" style="color:'+color+'">--</div>\n\
						<div class="hrs" style="color:'+color+'">--</div>\n\
						<div class="min" style="color:'+color+'">--</div>\n\
						<div class="sec" style="color:'+color+'">--</div>\n\
						<div class="days_descr">Дней</div>\n\
						<div class="hrs_descr">Часов</div>\n\
						<div class="min_descr">Минут</div>\n\
						<div class="sec_descr">Секунд</div>\n\
					</div>'
			
			
		},
		renderMap: function(class_name, obj, center){
			return '<div class="'+class_name+'" data-map-obj="'+_.escape(JSON.stringify(obj))+'" data-map-center="'+_.escape(JSON.stringify(center))+'"><div class="map_inner"></div></div>';
		},
		btnRender: function(obj, class_name, show_btn, caption){
                    var hidden = '';
                    if(typeof(obj)==='undefined'){
                       return '';
                    }
                    if(typeof(show_btn)==='undefined'){
                        show_btn==1;
                    }
                    if(show_btn ==0){
                        hidden=' hidden ';
                    }
                    var title = obj.title;
                    
   
                    
                    if(typeof(caption)!=='undefined'){
                        title=caption;
                    }
                    
                    
                    var open_tag = 'div',
                            close_tag= 'div';
                    
                    if(obj.use_form==0){
                        open_tag = 'a href="'+obj.link+'"';
                        close_tag= 'a';
                    }
                    
                    var add_basket = '';

                    if(obj.use_form==2){
                        add_basket = ' add_basket ';
                    }
                    
                    var style = '  ';
                    if(typeof(obj.style)!=='undefined'){
                        
                        
                        $.each(App.btn_styles, function(i,el){
                            
                            if(el.id==obj.style){
                                style = ' border-radius: '+el.css+'; ';
                                
                            }
                            
                        })
                        
                        
                    }
                    var shadow = '  ';
                    if(typeof(obj.shadow)!=='undefined'){
                        
                        
                        $.each(App.btn_shadows, function(i,el){
                            
                                if(el.id==obj.shadow){
                                var color_hex = App.hexToRgb(obj.color);
                                var css = el.css;
                                if(obj.shadow==3){
                                    color_hex.r = color_hex.r-30;
                                    color_hex.g = color_hex.g-30;
                                    color_hex.b = color_hex.b-30;
                                    if(color_hex.r<0){color_hex.r=0}
                                    if(color_hex.g<0){color_hex.g=0}
                                    if(color_hex.b<0){color_hex.b=0}
                                    css = css.replace('rgba(0,0,0,0.4)', '');
                                    css = css+ ' rgb('+color_hex.r+','+color_hex.g+','+color_hex.b+') ';
                                }
                                shadow = ' box-shadow: '+css+'; ';
                            }
                            
                        })
                        
                        
                    }
                    var animation = ' ';
                    if(typeof(obj.animation)!=='undefined'){
                        
                        if(parseInt(obj.animation)==1){
                            animation = ' animation ';
                            
                        }else{
                            animation = '  ';
                            
                        }
                    
                    }
                    
                    
                    
                    
                    if(!obj.surround){
                        return '<'+open_tag+' class="'+hidden+class_name+add_basket+' '+animation+'"  style="color:'+obj.color+'; '+style+' '+shadow+'">'+title+'</'+close_tag+'>';
                    }else{
                        return '<'+open_tag+' class="'+hidden+class_name+add_basket+' surround '+animation+'"  style="background-color:'+obj.color+'; '+style+' '+shadow+'">'+title+'</'+close_tag+'>'
                    }
		},
		
		
		// функция отрисовки окна спасибо.
		popupThanksRender: function (popup_thanks_title, popup_thanks_text) {
			return '<div class="popup_thanks">\n\
                        <div class="popup_thanks_inner">\n\
                            <div class="popup_thanks_close">X</div>\n\
                            <div class="popup_thanks_title">' + popup_thanks_title + '</div>\n\
                            <div class="popup_thanks_text">' + popup_thanks_text + '</div>\n\
                        </div>\n\
                    </div>\n\
                ';
		},
		popupFormRender: function (popup_form_title, popup_form_text, form, form_name) {
			var f = '';
			_.each(form, function(i){ f+= _.fieldRender(i) })
			
			return '<div class="popup_form">\n\
                            <div class="popup_form_inner">\n\
                                <div class="popup_form_close">X</div>\n\
                                <div class="popup_form_title">' + popup_form_title + '</div>\n\
                                <form action="handler.php" enctype="multipart/form-data" method="post">\n\
                                        <div class="'+form_name+'">'+ f +'</div>\n\
                                </form>\n\
                                <div class="popup_form_text">' + popup_form_text + '</div>\n\
                            </div>\n\
                    </div>\n\
                ';
		},
		popupHTMLFormRender: function ( html,form_name, html_name) {
			return '<div class="popup_form html_popup ">\n\
                            <div class="popup_form_inner">\n\
                                <div class="'+form_name+' ">\n\
                                    <div class="'+html_name+'">' + html + '</div>\n\
                                </div>\n\
                            </div>\n\
                        </div>\n\
                        ';
		},
		// функция отрисовки полей формы.
		fieldRender: function (data) {
			var required = '';
			if (data.required) {
				required = 'required="required"';
			}
                        var placeholder ='';
                        
//                        if(typeof(data.placeholder)!=='undefined' && data.placeholder!=''){
//                        }else{
//                            placeholder = '';
//                        }
                        
                            placeholder = ' placeholder="'+_.escape(data.title)+'" ';
                        
			if (data.type == 'text') {
				return '<div class="field"><div class="field_title">' + data.title + '</div><div class="field_description">' + data.description + '</div><div class="field_input"><input type="text" ' + required + ' name="' + data.title + '" '+placeholder+' /></div></div>';
			}
			if (data.type == 'email') {
				return '<div class="field"><div class="field_title">' + data.title + '</div><div class="field_description">' + data.description + '</div><div class="field_input"><input type="text" ' + required + ' name="' + data.title + '" '+placeholder+' /></div></div>';
			}
			if (data.type == 'phone') {
				return '<div class="field"><div class="field_title">' + data.title + '</div><div class="field_description">' + data.description + '</div><div class="field_input"><input type="text" ' + required + ' name="' + data.title + '" '+placeholder+' /></div></div>';
			}
			if (data.type == 'textarea') {
				return '<div class="field"><div class="field_title">' + data.title + '</div><div class="field_description">' + data.description + '</div><div class="field_input"><textarea ' + required + ' name="' + data.title + '" '+placeholder+'></textarea></div></div>';
			}
			if (data.type == 'list') {
				var list = '';
				$.each(data.options, function (i) {
					list += '<option value="' + data.options[i] + '">' + data.options[i] + '</option>';
				})
				return '<div class="field"><div class="field_title">' + data.title + '</div><div class="field_description">' + data.description + '</div><div class="field_input"><select ' + required + ' name="' + data.title + '">' + list + '</select></div></div>';
			}
			if (data.type == 'checkbox') {
				return '<div class="field"><div class="field_title"></div><div class="field_description">' + data.description + '</div><div class="field_input"><input type="checkbox" ' + required + ' name="' + data.title + '" /> ' + data.title + '</div></div>';
			}
			if (data.type == 'radio') {
				var list = '';
				_.each(data.options, function (i) {
					list += '<input type="radio" ' + required + '  value="' + i + '" name="' + data.title + '"> ' + i + ' ';
				})
				return '<div class="field"><div class="field_title">' + data.title + '</div><div class="field_description">' + data.description + '</div><div class="field_input">' + list + '</div></div>';
			}
			if (data.type == 'file') {
				return '<div class="field"><div class="field_title">' + data.title + '</div><div class="field_description">' + data.description + '</div><div class="field_input"><input type="file" ' + required + ' name="' + data.title + '" /></div></div>';
			}
			if (data.type == 'btn') {
                            
                                var style = '  ';
                                if(typeof(data.style)!=='undefined'){
                                    $.each(App.btn_styles, function(i,el){

                                        if(el.id==data.style){
                                            style = ' border-radius: '+el.css+'; ';

                                        }

                                    })
                                }                            
                                var shadow = '  ';
                                if(typeof(data.shadow)!=='undefined'){
                                    $.each(App.btn_shadows, function(i,el){

                                        if(el.id==data.shadow){
                                            var color_hex = App.hexToRgb(data.color);
                                            var css = el.css;
                                            if(data.shadow==3){
                                                color_hex.r = color_hex.r-30;
                                                color_hex.g = color_hex.g-30;
                                                color_hex.b = color_hex.b-30;
                                                if(color_hex.r<0){color_hex.r=0}
                                                if(color_hex.g<0){color_hex.g=0}
                                                if(color_hex.b<0){color_hex.b=0}
                                                css = css.replace('rgba(0,0,0,0.4)', '');
                                                css = css+ ' rgb('+color_hex.r+','+color_hex.g+','+color_hex.b+') ';
                                            }
                                            shadow = ' box-shadow: '+css+'; ';
                                        }

                                    })
                                }                            
                            
				if(!data.surround){
					return '<div class="field"><div class="field_input"><input type="submit" class="submit_btn" data-action="' + data.action + '" data-url="' + data.url + '"  data-amount="' + data.amount + '" value="' + data.title + '" style="color:' + data.color +  '; '+style+'; '+shadow+'" /></div></div>';
				}else{
					var color = '';
					if(data.color=="#FFFFFF"){
						color=' color:#3D3D3D;';
					}
					return '<div class="field"><div class="field_input"><input type="submit"  class="submit_btn surround" data-action="' + data.action + '" data-url="' + data.url + '"  data-amount="' + data.amount + '" value="' + data.title + '" style="background-color:' + data.color + '; '+color+'  '+style+'; '+shadow+'" /></div></div>';
					
				}
			}
			if (data.type == 'hidden') {
				return '<input type="hidden" name="' + data.title + '" value="' + data.description + '" />	';
			}
			return 'type in not defined';
		},
		menuRender: function(menu){
			var r = '<ul>';
                        
                        
                        
			_.each(menu,function(m){
                            var level = 0;
                            
                            if (typeof(m.level)==='undefined'){
                            } else{
                                level = m.level;
                            }                            
                            
                            r+='<li class="level'+level+'"><a href="'+m.link+'" title="'+m.title+'">'+m.title+'</a></li>';
                        })
			r+='</ul>'
			return r;
		},
		logoRender: function(logo){
			if((logo.use_image*1)==1){
				return '<img src="/img/'+logo.image_size+'x0/'+logo.image+'" alt="" />';
			}else{
				var b = '', i='';
				if((logo.bold*1)==1){
					b= ' font-weight: bold;';
				}
				if((logo.italic*1)==1){
					i=' font-style: italic;';
				}
				return '<span style="font-size:'+logo.text_size+'px; color:'+logo.color+'; font-family: \''+logo.font+'\'; '+b+i+'">'+logo.title+'</span>';
				
			}
			
		}
	});

	// пердустановка AJAX
	$.ajaxSetup({
		url: 'https://tobiz.net/system/editor/ajax.php',
		type: "POST",
		data: {},
		dataType: 'json',
		
		xhrFields: {
			withCredentials: true
		},
		crossDomain: true,
		success: function (data) {
			//console.log('success');
		},
		error: function (xhr, status, error) {
			//console.log('error');
		}
	});
	// Модальные окна.
	var window_style = {};

	function RemoveWindow() {
		
		
		$('#window').animate({left:'-1000px'},function(){
			
			$('#window').trigger('killWindow');
			$('#window').remove();
		})
		
	}
	function OpenWindow(title, content, class_name) {
		$('#window').stop(true,true);
		$('#window').remove();
		$('body').append('<div id="window" style="'+window_style[class_name]+'"  class="' + class_name + '"><div id="window_close">X</div><div id="window_title">' + title + '</div><div id="window_inner">' + content + '</div></div>');
//		$("#window").draggable({handle: '#window_title', stop: function () {
//				window_style[class_name] = 'top:'+$('#window').css('top')+'; left:'+$('#window').css('left')+';';
//		}});
	}
	$('body').on('click', '#window_close', function () {
		RemoveWindow();
	})
	$(document).on('click', document, function (event) {
		if ($(event.target).closest('#window, .tools, #add_section, #add_widgets, [data-editor], #batch_color_change').length)
			return;
		if ($("#window").size()) {
			RemoveWindow();
		}
		event.stopPropagation();
	});

	$('body').on('mouseover', '[data-editor] .overlay', function(){
		var size = $(this).width();
		if($(this).height()<size)
			size = $(this).height();
		
		
		
		$(this).children('i').css({width:(size/2)+'px'});
		$(this).children('i').css({height:(size/2)+'px'});
		
		$(this).children('i').css({marginTop:'-'+(size/4)+'px'});
		$(this).children('i').css({marginLeft:'-'+(size/4)+'px'});
		
		
		
		$(this).css({fontSize:size/2+'px'});
		
		
	})


	$.ajax({
		data: {action: 'GetBlocks', rep_id: App.rep_id},
		success: function (data) {

			if (data.status == 'OK') {
					

					
					App.userBlocks = $.parseJSON(data.respons);
                                        
					$.each(App.userBlocks, function (i) {
                                            
                                            
						App.userBlocks[i].data = $.parseJSON(App.userBlocks[i].data);
						$('#wrapper').append(render(App.userBlocks[i].type_id, App.userBlocks[i].id, App.userBlocks[i].data, App.userBlocks[i].position));
                                                App.events.afterBlockRender(App.userBlocks[i].id);
                                                
					})
                                        
                                        
					var way = window.location.hash;
					if(way.indexOf('alert-install')>-1){
						//OpenWindow('Шаблон установлен', 'Теперь можете приступить к его редактированию.', 'install-template-compile');
						//$('#intro').click();
						window.location.hash = '';
                                                //OpenWindow('', 'Видео инструкция по использованию редактора.', 'alert_intro');

//						setTimeout(function(){
//							RemoveWindow();
//						},3000);
//						
//						
//						$('body').one('killWindow','#window',function(){
//						})
						
					}
					
					

			} else {
				//console.log('Ошибка! ' + data.respons);
			}
		}
	})



	//	Добавление нового блока. Получение ID с сервера.
	function CreateNewBlock(type_id,default_values,position) {
		$.ajax({
			data: {action: 'CreateNewBlock', rep_id: App.rep_id, type_id: type_id},
			success: function (data) {
				if (data.status == 'OK') {
					data.respons = $.parseJSON(data.respons);
					App.userBlocks.push({
						id: data.respons.block_id,
						user_id: App.user_id,
						sort_id: 0,
						type_id: type_id,
						page_id: App.rep_id,
						save: 0,
						cache: '',
						position: position,
						data: '',
						deleted: 0
					});
					//console.log('Создан блок ' + data.respons.block_id);
					$('#wrapper').append(render(type_id, data.respons.block_id, default_values, position));
					$('#b_' + data.respons.block_id).addClass('change');
                                        App.events.afterBlockRender(data.respons.block_id);
					return data.respons.block_id;
				} else {
					//console.log('Ошибка! ' + data.respons);
				}
			}
		})
	}

	// функция рендеринга / ререндеринга блоков.
	function render(type_id, id, data, position) {
		type_id = type_id * 1;
		if (!type_id)
			return false;
		if (!id) {
			CreateNewBlock(type_id,data,position);
			return ''; // передаем управление в создание нового блока.
		}
                position = position*1;
                if(position==0){
                    //используем позицию по умолчанию
                    position = App.blocksDefaultPositions[type_id]*1; 
                }
                
                
                

                
                
                
                
                
                
		//var model = _.clone(_.findWhere(App.blocks, {type_id: type_id}));
		var model = _.cloneDeep(_.findWhere(App.blocks, {type_id: type_id}));
		if (data && data != '') {
                        
                        
                        model.values = _.cloneDeep(_.extend(_.cloneDeep(model.values), _.cloneDeep(data)));
                        //model.values = _.cloneDeep($.extend(true, _.cloneDeep(model.values), _.cloneDeep(data)));

                        
                        
		}


		var block = $.parseHTML(_.template(model.template)(model.values));
		
		
		if(model.type_id==63){
			block = $.parseHTML(_.template(model.template)(model.values));
			//block = $.parseHTML(_.template(model.template)(model.values), document ,true);
			//console.log('eval');
		}
		
		
		
                $(block).attr('id', 'b_' + id);
		$(block).attr('data-id', id);
		$(block).addClass('type_id_' + model.type_id);
		
		$(block).prepend('<div class="tools">\n\
				<span data-conf="' + id + '"><i class="fa fa-cogs"></i></span>\n\
				<span data-kill="' + id + '"><i class="fa fa-trash"></i></span>  \n\
				<span data-move="' + id + '"><i class="fa fa-arrows"></i></span>\n\
		</div><div class="tools_left"></div>');
		
                if(App.user_id=="15" || App.user_id=="17"){
                    $(block).prepend('<div class="block_type_id">' + model.type_id + '</div>'); 
                }
                

                
                
                
		var search = 1;
		
		
		
		_.each(App.sections, function(object,index){
				_.each(object.blocks, function(o,i){
					if(o.position==position && search){
						
						if(object.blocks.length>1 && !object.invisible){
							
							$(block).children('.tools_left').prepend('<span data-way="right"><i class="fa fa-arrow-right"></i></span>');
							$(block).children('.tools_left').prepend('<span data-way="left"><i class="fa fa-arrow-left"></i></span>');
						

							search =0;
						
						}
					}
				})
		})

		
		if(model.values.anchor){
			$(block).prepend('<a name="'+model.values.anchor+'"></a>');
		}else{
			$(block).prepend('<a name="a_'+id+'"></a>');
			model.values.anchor = 'a_'+id;
		}
		
		function setEditor(v) {
                    
                        
                    
			$(block).find('.' + v.name).attr('data-editor', v.editor);
			$(block).find('.' + v.name).attr('data-name', v.name);
			
			if(v.editor=='btn'){
				$(block).find('.' + v.name).attr('data-form', v.form);
			}
			
			if (v.editor == 'text') {
				$(block).find('.' + v.name).attr('contenteditable', 'true');
				$(block).find('.' + v.name).attr('spellcheck', 'false');
			} else if (v.editor == 'image'){
				
				$(block).find('.' + v.name).append('<div class="overlay"><i class="fa fa-pencil-square-o"></i></div>');
			
			}else if (v.editor == 'image_box'){
				
				//$(block).find('.' + v.name).append('<div class="overlay"></div>');
			
			}else if(v.editor == 'form'){
                            
                                if($(block).find('[data-editor="html"]').size()>0){
                                    $(block).find('.' + v.name).removeAttr('data-editor');
                                    $(block).find('.' + v.name).removeAttr('data-name');                                    
                                    
                                    
                                    return false;
                                }
				$(block).find('.' + v.name).append('<div class="overlay"><i class="fa fa-pencil-square-o"></i></div>');
				
			}else{
				$(block).find('.' + v.name).append('<div class="overlay"><i class="fa fa-pencil-square-o"></i></div>');
				
			}
		}
		$.each(model.vars, function (i) {
			setEditor(model.vars[i]);
		});
		if (model.var_boxs) {
			$.each(model.var_boxs, function (i) {
				$(block).find('.' + model.var_boxs[i].name).attr('data-var-box', model.var_boxs[i].name);
				$.each(model.var_boxs[i].vars, function (j) {
					setEditor(model.var_boxs[i].vars[j]);
				})
				if(model.var_boxs[i].type=='inline'){
					$(block).find('.' + model.var_boxs[i].name).each(function () {
						$(this).attr('data-var-box-type', 'inline');
					})
					
				}
				$(block).find('.' + model.var_boxs[i].name).each(function (k) {
					$(this).attr('data-var-box-id', k);
				})
			});
		}
		
		
		
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data = _.clone(model.values); //?? extand
		userBlock.position = position; //?? extand
		return block;
	}
	// рендеринг кеша
	function renderCache(userBlock) {
		var model = _.clone(_.findWhere(App.blocks, {type_id: userBlock.type_id * 1}));
		model.values = userBlock.data;
		var cache = _.template(model.template)(model.values);
		cache = $.parseHTML(cache, document, true);
		
		if(model.values.anchor){
			$(cache).prepend('<a name="'+model.values.anchor+'"></a>');
		}else{
			$(cache).prepend('<a name="a_'+userBlock.id+'"></a>');
			model.values.anchor = 'a_'+userBlock.id;
		}
		$(cache).attr('data-id', userBlock.id);
		$(cache).attr('id', 'b_'+userBlock.id);
		
		return $(cache)[0].outerHTML;
	}
	
	CKEDITOR.disableAutoInline = true;

	//Тектовый редактор.
	$('#wrapper').on('focus', '[contenteditable]', function () {
		
		var $this = $(this);
		
//		for (name in CKEDITOR.instances) {
//			CKEDITOR.instances[name].destroy();
//		}
		
		try{
			
			
			var instance = CKEDITOR.inline($(this)[0],{
				customConfig: '/system/ckeditor/tobiz_conf.js',
			});
			
                        
                        

			
			instance.config.removePlugins = 'youtube,a11yhelp,dialogadvtab,bidi,blockquote,resize,elementspath,enterkey,entities,popup,filebrowser,find,horizontalrule,htmlwriter,wysiwygarea,image,magicline,maximize,pastetext,selectall,showblocks,showborders,sourcearea,specialchar,stylescombo,tab,tabletools,wsc';
			instance.config.toolbar = [
				{name: 'editing', items: ['Undo','Redo','Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', 'RemoveFormat' ]},
				{name: 'justify', items: ['NumberedList','BulletedList','JustifyLeft', 'JustifyCenter', 'JustifyRight','JustifyBlock']},
				{name: 'link', items: ['Link', 'Unlink'	]},
				'/',
				{name: 'styles', items: ['Font', 'Format', 'FontSize', 'TextColor', 'lineheight']},
				{name: 'indent', items: ['Indent', 'Outdent']},
				//'Font', 'FontSize', 'TextColor'
			];
                        
                        


                        
			
			
		} catch(e){
			//console.log(e);
		}
		

		
//		for (name in CKEDITOR.instances) {
//			CKEDITOR.instances[name].destroy();
//		}		
		
		$this.data('before', $this.html());
		return $this;
		//blur keyup paste input
	}).on('focusout', '[contenteditable]', function () {
		var $this = $(this);
		if ($this.data('before') !== $this.html()) {
			$this.data('before', $this.html());
			$this.trigger('change');
		}
                $this.trigger('change'); //fix
		return $this;
	});
	$('#wrapper').on('change', '[data-editor="text"]', function () {
		$(this).closest('.section').addClass('change');
		var id = $(this).closest('.section').data('id');
		var name = $(this).data('name');
		var html = $(this).html();
		var var_box = $(this).closest('[data-var-box]')
		$.each(App.userBlocks, function (index) {
			if (App.userBlocks[index].id == id) {
				if (var_box.size()) {
					if(name=='popup_form_title' || name=='popup_form_text' || name=='popup_thanks_text' || name=='popup_thanks_title'){
						App.userBlocks[index].data[name] = html;
						return;
						
					}
					
					
					App.userBlocks[index].data[var_box.data('varBox')][var_box.data('varBoxId')][name] = html;
					return;
				} else {
					App.userBlocks[index].data[name] = html;
					return;
				}
			}
		})
	});
		
//	$('#wrapper').on('paste','[contenteditable]',function(e) {
//		e.preventDefault();
//		var text = (e.originalEvent || e).clipboardData.getData('text/html') || (e.originalEvent || e).clipboardData.getData('text/plain') || prompt('Paste something..');
//		var result = $('<div></div>').append(text);
//		document.execCommand("insertHTML", false, result.text());
//	});	
	
	
	
	// Редактор иконок.
	$('#wrapper').on('click', '[data-editor="icon"]', function () {
		var id = $(this).closest('.section').data('id');
		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
		var var_name = $(this).data('name');
		var html = '';
		$.each(App.icons, function (i) {
			html += '<i class="fa ' + App.icons[i] + '" data-value="' + App.icons[i] + '" data-id="' + id + '" data-name="' + var_name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"></i>';
		})
		html += '<div class="clear"></div>';
		OpenWindow('Выберите иконку', html, 'icon_pick');
	});
	$('body').on('click', '.icon_pick i.fa', function () {
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')] = $(this).data('value');
		} else {
			userBlock.data[$(this).data('name')] = $(this).data('value')
		}
		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
		App.events.afterBlockRender(id);		
		$('#b_' + id).addClass('change');
		RemoveWindow();
	})
        
        
	// Редактор цвтных иконок.
        

	$('#wrapper').on('click', '[data-editor="cicon_check_and_uncheck"]', function () {

            var id = $(this).closest('.section').data('id');
            var var_box_name = $(this).closest('[data-var-box]').data('varBox');
            var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
            var var_name = $(this).data('name');
            var html = '';
            $.each(App.cicon_check_and_uncheck, function (i) {
                    html += '<div class="cicon" style="background-image: url(/cicons/'+App.cicon_check_and_uncheck[i]+')"  data-value="' + App.cicon_check_and_uncheck[i] + '" data-id="' + id + '" data-name="' + var_name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"></div>';
            })
            html += '<div class="clear"></div>';
            OpenWindow('Выберите иконку', html, 'cicon_pick');
	});
	$('#wrapper').on('click', '[data-editor="cicon"]', function () {

            var id = $(this).closest('.section').data('id');
            var var_box_name = $(this).closest('[data-var-box]').data('varBox');
            var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
            var var_name = $(this).data('name');
            var html = '';
            $.each(App.cicons, function (i) {
                    html += '<div class="cicon" style="background-image: url(/cicons/'+App.cicons[i]+')"  data-value="' + App.cicons[i] + '" data-id="' + id + '" data-name="' + var_name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"></div>';
            })
            html += '<div class="clear"></div>';
            OpenWindow('Выберите иконку', html, 'cicon_pick');
	});
	$('body').on('click', '.cicon_pick div.cicon', function () {
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')] = $(this).data('value');
		} else {
			userBlock.data[$(this).data('name')] = $(this).data('value')
		}
		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
		App.events.afterBlockRender(id);		
		$('#b_' + id).addClass('change');
		RemoveWindow();
	})

	// Редактор карты
	
	


	// Редактор кнопок
	$('#wrapper').on('click', '[data-editor="btn"]', function () {
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var form = $(this).data('form');
		
		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');		

//		console.log(var_box_name);
//		console.log(var_box_id);

		var btn_title = '';
                var btn_link = '';
		var surround = '';
		var animation = '';
                
                
                var checked_0='';
                var checked_1='';
                var checked_2='';
                
                
                

                
                var radius_editor='';
                $.each(App.btn_styles, function(i, el){
                    var style_checked = '';
                    if (var_box_name && var_box_name!='undefined') {
                        if(typeof(userBlock.data[var_box_name][var_box_id][name].style)!=='undefined'){
                            if(userBlock.data[var_box_name][var_box_id][name].style==el.id){
                                style_checked = ' checked="checked" '
                            }
                        }
                    }else{
			if(typeof(userBlock.data[name].style)!=='undefined'){
                            if(userBlock.data[name].style==el.id){
                                style_checked = ' checked="checked" '
                            }                            
                        }                        
                    }
                    var br = '';
                    if(el.id%2==0){
                        br='<br />';
                    }
                    radius_editor += '<label><input type="radio" value="'+el.id+'" '+style_checked+' name="btn_style" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" > <span style="border-radius: '+el.css+'; background-color: rgb(0, 102, 153); color: rgb(255, 255, 255); font-size: 13px; padding: 0px 10px; margin-left: 9px; line-height: 250%; text-align:center; margin-bottom:5px;">'+el.title+'</span></label>'+br;
                })
                
                
                var shadow_editor='';
                $.each(App.btn_shadows, function(i, el){
                    var shadow_checked = '';
                    if (var_box_name && var_box_name!='undefined') {
                        if(typeof(userBlock.data[var_box_name][var_box_id][name].shadow)!=='undefined'){
                            if(userBlock.data[var_box_name][var_box_id][name].shadow==el.id){
                                shadow_checked = ' checked="checked" '
                            }
                        }
                    }else{
			if(typeof(userBlock.data[name].shadow)!=='undefined'){
                            if(userBlock.data[name].shadow==el.id){
                                shadow_checked = ' checked="checked" '
                            }                            
                        }                        
                    }
                    var br = '';
                    if(el.id%2==0){
                        br='<br />';
                    }
                    shadow_editor += '<label><input type="radio" value="'+el.id+'" '+shadow_checked+' name="btn_shadow" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" > <span style="box-shadow: '+el.css+'; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-size: 13px; padding: 0px 10px; margin-left: 9px; line-height: 250%; text-align:center;  margin-bottom:5px;">'+el.title+'</span></label>'+br;
                })
                
                
                
		if (var_box_name && var_box_name!='undefined') {
			btn_title = userBlock.data[var_box_name][var_box_id][name].title;
                        if(typeof(userBlock.data[var_box_name][var_box_id][name].link)!=='undefined'){
                            btn_link = userBlock.data[var_box_name][var_box_id][name].link;
                        }

                        if(typeof(userBlock.data[var_box_name][var_box_id][name].use_form)!=='undefined'){
                            if(userBlock.data[var_box_name][var_box_id][name].use_form==0){
                                checked_0 =' checked="checked" ';
                            } else if(userBlock.data[var_box_name][var_box_id][name].use_form==1){
                                checked_1 =' checked="checked" ';
                            } else if(userBlock.data[var_box_name][var_box_id][name].use_form==2){
                                checked_2 =' checked="checked" ';
                                
                            }
                            
                        }
                        if(typeof(userBlock.data[var_box_name][var_box_id][name].animation)!=='undefined'){
                            if(userBlock.data[var_box_name][var_box_id][name].animation==1){
                                animation =' checked="checked" ';
                            } else {
                                animation =' ';
                            }
                        }
                        
                        
			if(userBlock.data[var_box_name][var_box_id][name].surround){
				surround = ' checked = "checked" ';
			}
			
                            
		} else {
                    
			if(typeof(userBlock.data[name].link)!=='undefined'){
                            btn_link = userBlock.data[name].link;
                        }
                        
                        
			if(typeof(userBlock.data[name].use_form)!=='undefined'){
                            //console.log(userBlock.data[name].use_form)

                            
                            if(userBlock.data[name].use_form==0){
                                checked_0 =' checked="checked" ';
                            } else if(userBlock.data[name].use_form==1){
                                checked_1 =' checked="checked" ';
                            } else if(userBlock.data[name].use_form==2){
                                checked_2 =' checked="checked" ';
                                
                            }                            
                        }
			if(typeof(userBlock.data[name].animation)!=='undefined'){

                            
                            if(userBlock.data[name].animation==1){
                                animation =' checked="checked" ';
                            } else {
                                animation =' ';
                                
                            }                            
                        }
                        
                        
			btn_title = userBlock.data[name].title;
			if(userBlock.data[name].surround){
				surround = ' checked = "checked" ';
			}
			
		}		
		
                var use_basket = '';
                
                if(userBlock.type_id==128 || userBlock.type_id==200  ||  userBlock.type_id==201 || userBlock.type_id==125 || userBlock.type_id==124 || userBlock.type_id==126 ){
                    
                use_basket = '<div><p>&nbsp;</p><input type="radio" '+checked_2+'  name="use_form" value="2" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" /> добавить в корзину <br /><div class="remark">Работает на тарифах <a target="_blank" href="https://tobiz.net/price/">линейки Grand</a></div></div>';
                    
                    
                }
		
		var  html = '</div><div id="btn_config">\n\
                                <div class="conf-wrap"><div class="conf-wrap-title">Параметры кнопок</div><div class="conf_item" ><input type="checkbox" value="1" '+surround+' name="btn_surround" id="btn_surround" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" > Объемная кнопка</div>\n\
                                <div class="conf_item" ><input type="checkbox" value="1" '+animation+' name="btn_animation" id="btn_animation" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" > Анимация кнопка</div>\n\
                                <div class="conf_item style_editor" >\n\
                                    <div class="spoiler-title">Форма кнопки:</div>\n\
                                    <div class="spoiler-content">'+radius_editor+'</div>\n\
                                </div>\n\
                                <div class="conf_item shadow_editor" >\n\
                                    <div class="spoiler-title">Тень кнопки:</div>\n\
                                    <div class="spoiler-content">'+shadow_editor+'</div>\n\
                                </div>\n\
                                <div class="conf_item" >Текст кнопки: <br /><input type="text" name="btn_title" id="btn_title" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="' + btn_title + '" ></div>\n\
                                <div id="btn_colors" class="conf_item">\n\
                                    <div>Цвет кнопки: </div>\n\
                                    <div class="color" data-color="#D62B2B" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#D62B2B"></div>\n\
                                    <div class="color" data-color="#3F7B16" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#3F7B16"></div>\n\
                                    <div class="color" data-color="#2D620A" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#2D620A"></div>\n\
                                    <div class="color" data-color="#4BD62B" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#4BD62B"></div>\n\
                                    <div class="color" data-color="#1C52A2" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#1C52A2"></div>\n\
                                    <div class="color" data-color="#7C085A" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#7C085A"></div>\n\
                                    <div class="color" data-color="#006699" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#006699"></div>\n\
                                    <div class="color" data-color="#558F3A" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#558F3A"></div>\n\
                                    <div class="color" data-color="#8F4200" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#8F4200"></div>\n\
                                    <div class="color" data-color="#DE7747" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#DE7747"></div>\n\
                                    <div class="color" data-color="#47DEC3" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#47DEC3"></div>\n\
                                    <div class="color" data-color="#4763DE" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#4763DE"></div>\n\
                                    <div class="color" data-color="#DEC347" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#DEC347"></div>\n\
                                    <div class="color" data-color="#AEDE47" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#AEDE47"></div>\n\
                                    <div class="color" data-color="#47DE77" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#47DE77"></div>\n\
                                    <div class="color" data-color="#AA0000" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#AA0000"></div>\n\
                                    <div class="color" data-color="#FF5555" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF5555"></div>\n\
                                    <div class="color" data-color="#FF6600" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF6600"></div>\n\
                                    <div class="color" data-color="#FFCC00" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FFCC00"></div>\n\
                                    <div class="color" data-color="#00CCFF" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#00CCFF"></div>\n\
                                    <div class="color" data-color="#D400AA" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#D400AA"></div>\n\
                                    <div class="color" data-color="#37C871" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#37C871"></div>\n\
                                    <div class="color" data-color="#7F2AFF" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#7F2AFF"></div>\n\
                                    <div class="color" data-color="#000000" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#000000"></div>\n\
                                    <div class="color" data-color="#FFFFFF" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FFFFFF"></div>\n\
                                    <div class="color" data-color="#FFB700" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FFB700"></div>\n\
                                    <div class="color" data-color="#FF5300" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF5300"></div>\n\
                                    <div class="color" data-color="#FF7600" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF7600"></div>\n\
                                    <div class="color" data-color="#04819E" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#04819E"></div>\n\
                                    <div class="color" data-color="#60B9CE" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#60B9CE"></div>\n\
                                    <div class="color" data-color="#330570" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#330570"></div>\n\
                                    <div class="color" data-color="#E266B7" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#E266B7"></div>\n\
                                    <div class="color" data-color="#CD0074" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#CD0074"></div>\n\
                                    <div class="color" data-color="#FF3100" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF3100"></div>\n\
                                    <div class="color" data-color="#009999" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#009999"></div>\n\
                                    <div class="color" data-color="#06276F" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#06276F"></div>\n\
                                    <div class="color" data-color="#4573D5" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#4573D5"></div>\n\
                                    \n\
                                    <div class="clear"></div>\n\
                                </div>\n\
                            </div><div class="conf-wrap"><div class="conf-wrap-title">Функции кнопок</div>\n\
                                <div>\n\
                                    <b>По клику открыть:</b><br />\n\
                                    <input type="radio" '+checked_0+' name="use_form" value="0" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" /> Ссылка или <a target="_blank" href="https://tobiz.net/support/?article=kak-stavit-yakor-na-odnostranichnyj-sajt">якорь</a>:  <br /><input type="text" name="link" value="'+btn_link+'" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" /> <i class="fa fa-link linklib"></i><div class="linklib_variants"></div> <br /><br />\n\
                                    <input type="radio" '+checked_1+'  name="use_form" value="1" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" /> всплывающее окно с формой <br />\n\
                                \n\
                                </div>\n\
                                <span id="edit_popup_form" data-id="' + id + '" data-form="' + form + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '">Редактировать форму</span>\n\
                                '+use_basket+'\n\
                                </div>';
		OpenWindow('Настройка кнопки', html, 'btn_config');
	})
        
        
	$('body').on('input', '.btn_config input[name="link"]', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].link = _.escape($(this).val());
		} else {
			userBlock.data[name].link = _.escape($(this).val());
		}		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	$('body').on('click', '.btn_config .linklib, .menu_config .linklib, .image_box_config .linklib ', function () {
                //console.log(1);
            var box = $(this).parent().children('.linklib_variants');
            
            if(box.css('display')=='none'){
                
                
                
                if(typeof(App.linklib)==='undefined'){
                    $.ajax({
                        data: {action: 'GetLinks', project_id: App.project_id},
                        success: function (data) {
                            if (data.status == 'OK') {
                                    App.linklib = data.respons;
                                    box.html('');
                                    box.show();
                                        $.each(App.linklib.pages, function(index, element){
                                            box.append('<div class="svlink" data-link="/?v='+element.id+'">'+element.title+'</div>');
                                        })
                            } else {
                                   // console.log('Ошибка! ' + data.respons);
                            }
                        }
                    })                


                }else{

                    box.html('');
                    box.show();
                    
                        $.each(App.linklib.pages, function(index, element){
                               box.append('<div class="svlink" data-link="/?v='+element.id+'">'+element.title+'</div>');
                        })
                }
            }else{
                $(this).parent().children('.linklib_variants').hide();
            }
	})
	$('body').on('click', '.vlink, .svlink', function () {
                $(this).parent().parent().children('input[name="link"]').val($(this).data('link'));
            
                $('.linklib_variants').hide();
                $(this).parent().parent().children('input[name="link"]').trigger('input');
                $(this).parent().parent().children('input[name="link"]').trigger('change');
                
                
	})
        
	$('body').on('change', '.btn_config input[name="use_form"]', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
                var val = $(this).val();
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
                    userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].use_form = val;
		} else {
                    userBlock.data[name].use_form = val;
		}		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})        
	$('body').on('change', '.btn_config input[name="btn_style"]', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
                var val = $(this).val();
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
                    userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].style = val;
		} else {
                    userBlock.data[name].style = val;
		}		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})        
      
	$('body').on('change', '.btn_config input[name="btn_shadow"]', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
                var val = $(this).val();
                
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
                    userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].shadow = val;
		} else {
                    userBlock.data[name].shadow = val;
		}	
                
                
                
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})        
      
        
        
	$('body').on('click', '.btn_config #btn_config .color', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].color = $(this).data('color');
		} else {
			userBlock.data[name].color = $(this).data('color');
		}		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		
	})
	
	$('body').on('change', '.btn_config #btn_surround', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			if($(this).prop( "checked" )){
				userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].surround = 1;
			}else{
				userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].surround = 0;
			}
			
		} else {
			if($(this).prop( "checked" )){
				userBlock.data[name].surround = 1;
			}else{
				userBlock.data[name].surround = 0;
			}
		}		
		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})	
        
	$('body').on('change', '.btn_config #btn_animation', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			if($(this).prop( "checked" )){
				userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].animation = 1;
			}else{
				userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].animation = 0;
			}
			
		} else {
			if($(this).prop( "checked" )){
				userBlock.data[name].animation = 1;
			}else{
				userBlock.data[name].animation = 0;
			}
		}		
		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})	
	
	
	$('body').on('input', '.btn_config #btn_title', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			userBlock.data[$(this).data('varBox')][$(this).data('varBoxId')][$(this).data('name')].title = _.escape($(this).val());
		} else {
			userBlock.data[name].title = _.escape($(this).val());
		}		
		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})

	$('body').on('click', '#edit_popup_form', function () {
		var id = $(this).data('id') + '';
		var form = $(this).data('form') + '';
		
		RemoveWindow();
		$('.popup_thanks').hide();
		$('.popup_form').hide();
		
		if ($(this).data('varBox') && $(this).data('varBox')!='undefined') {
			$('#b_' + id).find('.'+$(this).data('varBox')).eq($(this).data('varBoxId')).find('.'+form).closest('.popup_form').show();
		} else {
			$('#b_' + id).find('.'+form).closest('.popup_form').show();
		}		
		
		
		//$('#b_' + id).find('.'+form).closest('.popup_form').show();
	})


// Редактор всех кнопок



	// Редактор кнопок
	$('#batch_color_change').click(function () {
            
            
            
            var radius_editor='';
            $.each(App.btn_styles, function(i, el){
                var br = '';
                if(el.id%2==0){
                    br='<br />';
                }
                radius_editor += '<label><input type="radio" value="'+el.id+'"  name="btn_style" id="btn_style" > <span style="border-radius: '+el.css+'; background-color: rgb(0, 102, 153); color: rgb(255, 255, 255); font-size: 11px; padding: 3px 10px; margin-left: 9px;">'+el.title+'</span></label>'+br;
            })
            
            
            var shadow_editor='';
            $.each(App.btn_shadows, function(i, el){
                var br = '';
                if(el.id%2==0){
                    br='<br />';
                }

                shadow_editor += '<label><input type="radio" value="'+el.id+'"  name="btn_shadow" > <span style="box-shadow: '+el.css+'; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-size: 13px; padding: 0px 10px; margin-left: 9px; line-height: 250%; text-align:center;  margin-bottom:5px;">'+el.title+'</span></label>'+br;
            })       
            
            
            
            var title_font_select='<select name="title_font_select"> ';
            var text_font_select='<select name="text_font_select"> ';
            var btn_font_select='<select name="btn_font_select"> ';
            $.each(App.fonts, function(i, el){

                text_font_select += '<option value="'+el.value+'">'+el.title+'</option>';
                title_font_select += '<option value="'+el.value+'">'+el.title+'</option>';
                btn_font_select += '<option value="'+el.value+'">'+el.title+'</option>';
            })            
            title_font_select +='</select> ';
            text_font_select +='</select> ';
            btn_font_select +='</select> ';
            
                            
            
            var  html = '</div><div id="batch_color_config">\n\
                        <div class="conf-wrap"><div class="conf-wrap-title">Цвет кнопок: </div>\n\
                        <div class="color" data-color="#D62B2B" style="background-color:#D62B2B"></div>\n\
                        <div class="color" data-color="#3F7B16" style="background-color:#3F7B16"></div>\n\
                        <div class="color" data-color="#2D620A" style="background-color:#2D620A"></div>\n\
                        <div class="color" data-color="#4BD62B" style="background-color:#4BD62B"></div>\n\
                        <div class="color" data-color="#1C52A2" style="background-color:#1C52A2"></div>\n\
                        <div class="color" data-color="#7C085A" style="background-color:#7C085A"></div>\n\
                        <div class="color" data-color="#006699" style="background-color:#006699"></div>\n\
                        <div class="color" data-color="#558F3A" style="background-color:#558F3A"></div>\n\
                        <div class="color" data-color="#8F4200" style="background-color:#8F4200"></div>\n\
                        <div class="color" data-color="#DE7747" style="background-color:#DE7747"></div>\n\
                        <div class="color" data-color="#47DEC3" style="background-color:#47DEC3"></div>\n\
                        <div class="color" data-color="#4763DE" style="background-color:#4763DE"></div>\n\
                        <div class="color" data-color="#DEC347" style="background-color:#DEC347"></div>\n\
                        <div class="color" data-color="#AEDE47" style="background-color:#AEDE47"></div>\n\
                        <div class="color" data-color="#47DE77" style="background-color:#47DE77"></div>\n\
                        <div class="color" data-color="#AA0000" style="background-color:#AA0000"></div>\n\
                        <div class="color" data-color="#FF5555" style="background-color:#FF5555"></div>\n\
                        <div class="color" data-color="#FF6600" style="background-color:#FF6600"></div>\n\
                        <div class="color" data-color="#FFCC00" style="background-color:#FFCC00"></div>\n\
                        <div class="color" data-color="#00CCFF" style="background-color:#00CCFF"></div>\n\
                        <div class="color" data-color="#D400AA" style="background-color:#D400AA"></div>\n\
                        <div class="color" data-color="#37C871" style="background-color:#37C871"></div>\n\
                        <div class="color" data-color="#7F2AFF" style="background-color:#7F2AFF"></div>\n\
                        <div class="color" data-color="#000000" style="background-color:#000000"></div>\n\
                        <div class="color" data-color="#FFFFFF" style="background-color:#FFFFFF"></div>\n\
                        <div class="color" data-color="#FFB700" style="background-color:#FFB700"></div>\n\
                        <div class="color" data-color="#FF5300" style="background-color:#FF5300"></div>\n\
                        <div class="color" data-color="#FF7600" style="background-color:#FF7600"></div>\n\
                        <div class="color" data-color="#04819E" style="background-color:#04819E"></div>\n\
                        <div class="color" data-color="#60B9CE" style="background-color:#60B9CE"></div>\n\
                        <div class="color" data-color="#330570" style="background-color:#330570"></div>\n\
                        <div class="color" data-color="#E266B7" style="background-color:#E266B7"></div>\n\
                        <div class="color" data-color="#CD0074" style="background-color:#CD0074"></div>\n\
                        <div class="color" data-color="#FF3100" style="background-color:#FF3100"></div>\n\
                        <div class="color" data-color="#009999" style="background-color:#009999"></div>\n\
                        <div class="color" data-color="#06276F" style="background-color:#06276F"></div>\n\
                        <div class="color" data-color="#4573D5" style="background-color:#4573D5"></div>\n\
                        <div class="clear"></div></div>\n\
                        <div class="conf-wrap"><div class="conf-wrap-title">Объемная кнопка:</div> <div data-surround="0">Все плоские</div><div data-surround="1" >Все объемные</div><br><br>\n\
                        <div class="conf_item style_editor" ><div class="spoiler-title">Форма кнопки:</div><div class="spoiler-content">'+radius_editor+'</div></div>\n\
                        <div class="conf_item shadow_editor" ><div class="spoiler-title">Тень кнопки:</div><div class="spoiler-content">'+shadow_editor+'</div></div>\n\
                        <div class="conf-wrap"><div class="conf-wrap-title">Шрифт:</div>\n\
                            Заголовок:<br>'+title_font_select+'<br>\n\
                            Основной текст:<br>'+text_font_select+'<br>\
                            Кнопки:<br>'+btn_font_select+'<br>\
                            </div></div>\n\
                        <div class="conf-wrap"><div class="conf-wrap-title">Цвет ссылок: </div>\n\
                        <div class="linkcolor" data-color="#D62B2B" style="background-color:#D62B2B"></div>\n\
                        <div class="linkcolor" data-color="#3F7B16" style="background-color:#3F7B16"></div>\n\
                        <div class="linkcolor" data-color="#2D620A" style="background-color:#2D620A"></div>\n\
                        <div class="linkcolor" data-color="#4BD62B" style="background-color:#4BD62B"></div>\n\
                        <div class="linkcolor" data-color="#1C52A2" style="background-color:#1C52A2"></div>\n\
                        <div class="linkcolor" data-color="#7C085A" style="background-color:#7C085A"></div>\n\
                        <div class="linkcolor" data-color="#006699" style="background-color:#006699"></div>\n\
                        <div class="linkcolor" data-color="#558F3A" style="background-color:#558F3A"></div>\n\
                        <div class="linkcolor" data-color="#8F4200" style="background-color:#8F4200"></div>\n\
                        <div class="linkcolor" data-color="#DE7747" style="background-color:#DE7747"></div>\n\
                        <div class="linkcolor" data-color="#47DEC3" style="background-color:#47DEC3"></div>\n\
                        <div class="linkcolor" data-color="#4763DE" style="background-color:#4763DE"></div>\n\
                        <div class="linkcolor" data-color="#DEC347" style="background-color:#DEC347"></div>\n\
                        <div class="linkcolor" data-color="#AEDE47" style="background-color:#AEDE47"></div>\n\
                        <div class="linkcolor" data-color="#47DE77" style="background-color:#47DE77"></div>\n\
                        <div class="linkcolor" data-color="#AA0000" style="background-color:#AA0000"></div>\n\
                        <div class="linkcolor" data-color="#FF5555" style="background-color:#FF5555"></div>\n\
                        <div class="linkcolor" data-color="#FF6600" style="background-color:#FF6600"></div>\n\
                        <div class="linkcolor" data-color="#FFCC00" style="background-color:#FFCC00"></div>\n\
                        <div class="linkcolor" data-color="#00CCFF" style="background-color:#00CCFF"></div>\n\
                        <div class="linkcolor" data-color="#D400AA" style="background-color:#D400AA"></div>\n\
                        <div class="linkcolor" data-color="#37C871" style="background-color:#37C871"></div>\n\
                        <div class="linkcolor" data-color="#7F2AFF" style="background-color:#7F2AFF"></div>\n\
                        <div class="linkcolor" data-color="#000000" style="background-color:#000000"></div>\n\
                        <div class="linkcolor" data-color="#FFFFFF" style="background-color:#FFFFFF"></div>\n\
                        <div class="linkcolor" data-color="#FFB700" style="background-color:#FFB700"></div>\n\
                        <div class="linkcolor" data-color="#FF5300" style="background-color:#FF5300"></div>\n\
                        <div class="linkcolor" data-color="#FF7600" style="background-color:#FF7600"></div>\n\
                        <div class="linkcolor" data-color="#04819E" style="background-color:#04819E"></div>\n\
                        <div class="linkcolor" data-color="#60B9CE" style="background-color:#60B9CE"></div>\n\
                        <div class="linkcolor" data-color="#330570" style="background-color:#330570"></div>\n\
                        <div class="linkcolor" data-color="#E266B7" style="background-color:#E266B7"></div>\n\
                        <div class="linkcolor" data-color="#CD0074" style="background-color:#CD0074"></div>\n\
                        <div class="linkcolor" data-color="#FF3100" style="background-color:#FF3100"></div>\n\
                        <div class="linkcolor" data-color="#009999" style="background-color:#009999"></div>\n\
                        <div class="linkcolor" data-color="#06276F" style="background-color:#06276F"></div>\n\
                        <div class="linkcolor" data-color="#4573D5" style="background-color:#4573D5"></div>\n\
                        <div class="clear"></div></div>\n\
                        </div>\n\
                    ';
            OpenWindow('Массовое изменение на сайте', html, 'batch_color_change_config');
	})
	$('body').on('click', '.batch_color_change_config .color', function () {
            
            var COLOR = $(this).data('color');
            $.each(App.userBlocks, function(i){
                
              var id =  App.userBlocks[i].id,
                  type_id =  App.userBlocks[i].type_id*1,
                  model = _.cloneDeep(_.findWhere(App.blocks, {type_id: type_id}));
                  
                //vars
                $.each(model.vars,function(j){
                    if(model.vars[j].editor=='btn'){
                        App.userBlocks[i].data[model.vars[j].name].color = COLOR;
                    }
                    if(model.vars[j].editor=='form'){
                        var form =  App.userBlocks[i].data[model.vars[j].name];
                        form[form.length-1].color = COLOR;
                    }
                })
                
                
                //var_boxs
                if(typeof(model.var_boxs)!=='undefined'){
                    $.each(model.var_boxs,function(jj){
                        if(typeof(model.var_boxs[jj].vars)!=='undefined'){
                            $.each(model.var_boxs[jj].vars,function(jjj){
                                if(model.var_boxs[jj].vars[jjj].editor=='btn' && typeof(model.var_boxs[jj].vars[jjj].name)!=='undefined'){
                                    //console.log(model.var_boxs[jj].name);
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        element[model.var_boxs[jj].vars[jjj].name].color = COLOR;
                                    })
                                }
                                if(model.var_boxs[jj].vars[jjj].editor=='form' && typeof(model.var_boxs[jj].vars[jjj].form)==='undefined'){
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        var form =element[model.var_boxs[jj].vars[jjj].name] ;
                                        form[form.length-1].color = COLOR;
                                    })                                    
                                }
                            })
                        }                
                    })                
                }
                $('#b_' + id).replaceWith(render(type_id, id, App.userBlocks[i].data));
                App.events.afterBlockRender(id);
            })
		
	})
	
	$('body').on('click', '.batch_color_change_config [data-surround]', function () {
            var surround = $(this).data('surround')*1;
            $.each(App.userBlocks, function(i){
              var id =  App.userBlocks[i].id,
                  type_id =  App.userBlocks[i].type_id*1,
                  model = _.cloneDeep(_.findWhere(App.blocks, {type_id: type_id}));
                  
                //vars
                $.each(model.vars,function(j){
                    if(model.vars[j].editor=='btn'){
                        App.userBlocks[i].data[model.vars[j].name].surround = surround;
                    }
                    if(model.vars[j].editor=='form'){
                        var form =  App.userBlocks[i].data[model.vars[j].name];
                        form[form.length-1].surround = surround;
                    }
                })
                
                
                //var_boxs
                if(typeof(model.var_boxs)!=='undefined'){
                    $.each(model.var_boxs,function(jj){
                        if(typeof(model.var_boxs[jj].vars)!=='undefined'){
                            $.each(model.var_boxs[jj].vars,function(jjj){
                                if(model.var_boxs[jj].vars[jjj].editor=='btn' && typeof(model.var_boxs[jj].vars[jjj].name)!=='undefined'){
                                    //console.log(model.var_boxs[jj].name);
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        element[model.var_boxs[jj].vars[jjj].name].surround = surround;
                                    })
                                }
                                if(model.var_boxs[jj].vars[jjj].editor=='form' && typeof(model.var_boxs[jj].vars[jjj].form)==='undefined'){
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        var form =element[model.var_boxs[jj].vars[jjj].name] ;
                                        form[form.length-1].surround = surround;
                                    })                                    
                                }
                            })
                        }                
                    })                
                }
                $('#b_' + id).replaceWith(render(type_id, id, App.userBlocks[i].data));
                App.events.afterBlockRender(id);
            })
		
	})

	$('body').on('change', '.batch_color_change_config input[name="btn_style"]', function () {
            var style = $(this).val()*1;
            $.each(App.userBlocks, function(i){
              var id =  App.userBlocks[i].id,
                  type_id =  App.userBlocks[i].type_id*1,
                  model = _.cloneDeep(_.findWhere(App.blocks, {type_id: type_id}));
                  
                //vars
                $.each(model.vars,function(j){
                    if(model.vars[j].editor=='btn'){
                        App.userBlocks[i].data[model.vars[j].name].style = style;
                    }
                    if(model.vars[j].editor=='form'){
                        var form =  App.userBlocks[i].data[model.vars[j].name];
                        form[form.length-1].style = style;
                    }
                })
                
                
                //var_boxs
                if(typeof(model.var_boxs)!=='undefined'){
                    $.each(model.var_boxs,function(jj){
                        if(typeof(model.var_boxs[jj].vars)!=='undefined'){
                            $.each(model.var_boxs[jj].vars,function(jjj){
                                if(model.var_boxs[jj].vars[jjj].editor=='btn' && typeof(model.var_boxs[jj].vars[jjj].name)!=='undefined'){
                                    //console.log(model.var_boxs[jj].name);
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        element[model.var_boxs[jj].vars[jjj].name].style = style;
                                    })
                                }
                                if(model.var_boxs[jj].vars[jjj].editor=='form' && typeof(model.var_boxs[jj].vars[jjj].form)==='undefined'){
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        var form =element[model.var_boxs[jj].vars[jjj].name] ;
                                        form[form.length-1].style = style;
                                    })                                    
                                }
                            })
                        }                
                    })                
                }
                $('#b_' + id).replaceWith(render(type_id, id, App.userBlocks[i].data));
                App.events.afterBlockRender(id);
            })
		
	})
	$('body').on('change', '.batch_color_change_config input[name="btn_shadow"]', function () {
            var shadow = $(this).val()*1;
            $.each(App.userBlocks, function(i){
              var id =  App.userBlocks[i].id,
                  type_id =  App.userBlocks[i].type_id*1,
                  model = _.cloneDeep(_.findWhere(App.blocks, {type_id: type_id}));
                  
                //vars
                $.each(model.vars,function(j){
                    if(model.vars[j].editor=='btn'){
                        App.userBlocks[i].data[model.vars[j].name].shadow = shadow;
                    }
                    if(model.vars[j].editor=='form'){
                        var form =  App.userBlocks[i].data[model.vars[j].name];
                        form[form.length-1].shadow = shadow;
                    }
                })
                
                
                //var_boxs
                if(typeof(model.var_boxs)!=='undefined'){
                    $.each(model.var_boxs,function(jj){
                        if(typeof(model.var_boxs[jj].vars)!=='undefined'){
                            $.each(model.var_boxs[jj].vars,function(jjj){
                                if(model.var_boxs[jj].vars[jjj].editor=='btn' && typeof(model.var_boxs[jj].vars[jjj].name)!=='undefined'){
                                    //console.log(model.var_boxs[jj].name);
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        element[model.var_boxs[jj].vars[jjj].name].shadow = shadow;
                                    })
                                }
                                if(model.var_boxs[jj].vars[jjj].editor=='form' && typeof(model.var_boxs[jj].vars[jjj].form)==='undefined'){
                                    $.each(App.userBlocks[i].data[model.var_boxs[jj].name], function(index,element){
                                        var form =element[model.var_boxs[jj].vars[jjj].name] ;
                                        form[form.length-1].shadow = shadow;
                                    })                                    
                                }
                            })
                        }                
                    })                
                }
                $('#b_' + id).replaceWith(render(type_id, id, App.userBlocks[i].data));
                App.events.afterBlockRender(id);
            })
		
	})
        
        App.configRender = function(){
            
            var style = '';
            if(typeof(App.page_config.text_font)!=='undefined'){
                style += '#wrapper {font-family: '+App.page_config.text_font+';} ';
            }
            if(typeof(App.page_config.btn_font)!=='undefined'){
                style += '.section .btn1,.section .btn2,.section .btn3,.section .btn4,.section .btn5, .section form input[type="submit"] {font-family: '+App.page_config.btn_font+';} ';
            }
            if(typeof(App.page_config.title_font)!=='undefined'){
                style += '.section .title {font-family: '+App.page_config.title_font+';} ';
            }
            if(typeof(App.page_config.link_color)!=='undefined'){
                style += 'a {color: '+App.page_config.link_color+';} ';
            }
            
            
            $('#page_style').replaceWith('<style id="page_style">'+style+'</style>');
            
            
        }
        
	$('body').on('change', 'select[name="title_font_select"]', function () {
            if(typeof(App.page_config)==='undefined'){
                App.page_config = {};
            }            
            App.page_config.title_font = $(this).val();
            App.configRender();
	})
	$('body').on('change', 'select[name="text_font_select"]', function () {
            if(typeof(App.page_config)==='undefined'){
                App.page_config = {};
            }            
            App.page_config.text_font = $(this).val();
            App.configRender();
	})
        
	$('body').on('change', 'select[name="form_font_select"]', function () {
            if(typeof(App.page_config)==='undefined'){
                App.page_config = {};
            }            
            App.page_config.form_font = $(this).val();
            App.configRender();
	})
	$('body').on('change', 'select[name="btn_font_select"]', function () {
            if(typeof(App.page_config)==='undefined'){
                App.page_config = {};
            }            
            App.page_config.btn_font = $(this).val();
            App.configRender();
	})



        $('body').on('click', '.batch_color_change_config .linkcolor', function () {
            
            var COLOR = $(this).data('color');
            
            if(typeof(App.page_config)==='undefined'){
                App.page_config = {};
            }            
            App.page_config.link_color = COLOR;
            App.configRender();

		
	})





	// Редактор форм.
	$('#wrapper').on('click', '[data-editor="form"]', function () {
		

		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});

		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');				
		
		if (var_box_name && var_box_name!='undefined') {

		} else {
		
		}	
		
		
		var html = '<div id="sort_box">';
		var icon = {
			text: '<i class="fa fa-text-width"></i>',
			textarea: '<i class="fa fa-text-height"></i>',
			email: '<i class="fa fa-envelope-o"></i>',
			phone: '<i class="fa fa-phone"></i>',
			checkbox: '<i class="fa fa-check-square-o"></i>',
			radio: '<i class="fa fa-dot-circle-o"></i>',
			list: '<i class="fa fa-list"></i>',
			file: '<i class="fa fa-file"></i>',
			hidden: '<i class="fa fa-eye-slash"></i>'
		};
		var k = 0;
		
		if (var_box_name && var_box_name!='undefined') {
			_.each(userBlock.data[var_box_name][var_box_id][name], function (i) {
				if (i.type == 'btn') {
					return
				}
				var checked = '';
				if (i.required) {
					checked = 'checked="checked"';
				}
				var options = '';
				if (i.options) {
					options = 'Варианты <textarea name="options">' + i.options.join('\n') + '</textarea>';
				}
				html += '<div class="field_editor" data-id="' + id + '" data-name="' + name + '" data-type="' + i.type + '" data-index="' + k + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '">';
				html += '<div class="field_editor_title">' + icon[i.type] + ' ' + i.title + ' <i class="fa fa-trash"></i></div>';
				html += '<div class="field_editor_content">Название: <input type="text" value="' + i.title + '" name="title">Описание: <input type="text" value="' + i.description + '" name="description">Обязательное поле: <input type="checkbox" value="1" name="required" ' + checked + '>' + options + '</div>';
				html += '</div>';
				k++;
			})	



		} else {
			_.each(userBlock.data[name], function (i) {
				if (i.type == 'btn') {
					return
				}
				var checked = '';
				if (i.required) {
					checked = 'checked="checked"';
				}
				var options = '';
				if (i.options) {
					options = 'Варианты <textarea name="options">' + i.options.join('\n') + '</textarea>';
				}
				html += '<div class="field_editor" data-id="' + id + '" data-name="' + name + '" data-type="' + i.type + '" data-index="' + k + '">';
				html += '<div class="field_editor_title">' + icon[i.type] + ' ' + i.title + ' <i class="fa fa-trash"></i></div>';
				html += '<div class="field_editor_content">Название: <input maxlength="30" type="text" required="required" value="' + i.title + '" name="title">Описание: <input type="text" value="' + i.description + '" name="description">Обязательное поле: <input type="checkbox" value="1" name="required" ' + checked + '>' + options + '</div>';
				html += '</div>';
				k++;
			})		
		}			
		

		var add_field_picker = '';
		_.each(icon, function (i, v) {
                    
                    if(userBlock.type_id==306){ // fix 306 block
                        if(_.indexOf(['text','email','phone','hidden'],v)!=-1){
                            add_field_picker += '<div class="field_type" data-name="' + name + '" data-id="' + id + '" data-type="' + v + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  >' + i + '</div>';
                        }
                    }else{
			add_field_picker += '<div class="field_type" data-name="' + name + '" data-id="' + id + '" data-type="' + v + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  >' + i + '</div>';
                    }
                    
		})
		add_field_picker += '<div class="clear"></div>';
		html += '</div><div id="add_field">Добавить поле:</div><div id="add_field_picker">' + add_field_picker + '<div>';
		var actions = {thanks: '', redirect: '', pay: '', subscription: ''};
		var btn_text = '',amount='', url='', subscription='';
		var surround ='';
		if (var_box_name && var_box_name!='undefined') {
			actions[userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].action] = 'checked="checked"';
			btn_text= userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].title
			amount =  userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].amount;
			url =userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].url;
			subscription =userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].subscription;
			
			if(userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].surround){
				surround = ' checked = "checked" ';
				
			}			
			
		}else{
			actions[userBlock.data[name][userBlock.data[name].length - 1].action] = 'checked="checked"';
			btn_text= userBlock.data[name][userBlock.data[name].length - 1].title
			amount =  userBlock.data[name][userBlock.data[name].length - 1].amount;
			url =userBlock.data[name][userBlock.data[name].length - 1].url;
			subscription =userBlock.data[name][userBlock.data[name].length - 1].subscription;
			
			if(userBlock.data[name][userBlock.data[name].length - 1].surround){
				surround = ' checked = "checked" ';
				
			}			
			
		}
		
                
                
                
                var radius_editor='';
                $.each(App.btn_styles, function(i, el){
                    var style_checked = '';
                    if (var_box_name && var_box_name!='undefined') {
                        if(typeof(userBlock.data[var_box_name][var_box_id][name].style)!=='undefined'){
                            if(userBlock.data[var_box_name][var_box_id][name].style==el.id){
                                style_checked = ' checked="checked" '
                            }
                        }
                    }else{
			if(typeof(userBlock.data[name].style)!=='undefined'){
                            if(userBlock.data[name].style==el.id){
                                style_checked = ' checked="checked" '
                            }                            
                        }                        
                    }
                    var br = '';
                    if(el.id%2==0){
                        br='<br />';
                    }
                    radius_editor += '<label><input type="radio" value="'+el.id+'" '+style_checked+' name="btn_style" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" > <span style="border-radius: '+el.css+'; background-color: rgb(0, 102, 153); color: rgb(255, 255, 255); font-size: 13px; padding: 0px 10px; margin-left: 9px; line-height: 250%; padding: 0px 10px; margin-left: 9px; line-height: 250%; text-align:center; margin-bottom:5px;">'+el.title+'</span></label>'+br;
                })                
                
                var shadow_editor='';
                $.each(App.btn_shadows, function(i, el){
                    var shadow_checked = '';
                    if (var_box_name && var_box_name!='undefined') {
                        if(typeof(userBlock.data[var_box_name][var_box_id][name].shadow)!=='undefined'){
                            if(userBlock.data[var_box_name][var_box_id][name].shadow==el.id){
                                shadow_checked = ' checked="checked" '
                            }
                        }
                    }else{
			if(typeof(userBlock.data[name].shadow)!=='undefined'){
                            if(userBlock.data[name].shadow==el.id){
                                shadow_checked = ' checked="checked" '
                            }                            
                        }                        
                    }
                    var br = '';
                    if(el.id%2==0){
                        br='<br />';
                    }
                    shadow_editor += '<label><input type="radio" value="'+el.id+'" '+shadow_checked+' name="btn_shadow" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" > <span style="box-shadow: '+el.css+'; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-size: 13px; padding: 0px 10px; margin-left: 9px; line-height: 250%; text-align:center;  margin-bottom:5px;">'+el.title+'</span></label>'+br;
                })                
                
                
                
		
		html += '</div></div>\n\
                            <div class="conf-wrap"><div class="conf-wrap-title">Параметры кнопок</div><div id="btn_config">\n\
				<div class="conf_item style_editor" ><div class="spoiler-title">Форма кнопки:</div><div class="spoiler-content">'+radius_editor+'</div></div>\n\
                                <div class="conf_item shadow_editor" >\n\
                                    <div class="spoiler-title">Тень кнопки:</div>\n\
                                    <div class="spoiler-content">'+shadow_editor+'</div>\n\
                                </div>\n\
                                <div class="conf_item"><input type="checkbox" value="1" '+surround+' name="btn_surround" id="btn_surround" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" > Объемная кнопка</div>\n\
                                <div id="btn_colors"  class="conf_item">\n\
                                Цвет кнопки: <br />\n\
                                <div class="color" data-color="#D62B2B" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#D62B2B"></div>\n\
                                <div class="color" data-color="#3F7B16" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#3F7B16"></div>\n\
                                <div class="color" data-color="#2D620A" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#2D620A"></div>\n\
                                <div class="color" data-color="#4BD62B" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#4BD62B"></div>\n\
                                <div class="color" data-color="#1C52A2" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#1C52A2"></div>\n\
                                <div class="color" data-color="#7C085A" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#7C085A"></div>\n\
                                <div class="color" data-color="#006699" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#006699"></div>\n\
                                <div class="color" data-color="#558F3A" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#558F3A"></div>\n\
                                <div class="color" data-color="#8F4200" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#8F4200"></div>\n\
                                <div class="color" data-color="#DE7747" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#DE7747"></div>\n\
                                <div class="color" data-color="#47DEC3" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#47DEC3"></div>\n\
                                <div class="color" data-color="#4763DE" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#4763DE"></div>\n\
                                <div class="color" data-color="#DEC347" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#DEC347"></div>\n\
                                <div class="color" data-color="#AEDE47" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#AEDE47"></div>\n\
                                <div class="color" data-color="#47DE77" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#47DE77"></div>\n\
                                <div class="color" data-color="#AA0000" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#AA0000"></div>\n\
                                <div class="color" data-color="#FF5555" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF5555"></div>\n\
                                <div class="color" data-color="#FF6600" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF6600"></div>\n\
                                <div class="color" data-color="#FFCC00" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FFCC00"></div>\n\
                                <div class="color" data-color="#00CCFF" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#00CCFF"></div>\n\
                                <div class="color" data-color="#D400AA" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#D400AA"></div>\n\
                                <div class="color" data-color="#37C871" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#37C871"></div>\n\
                                <div class="color" data-color="#7F2AFF" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#7F2AFF"></div>\n\
                                <div class="color" data-color="#000000" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#000000"></div>\n\
                                <div class="color" data-color="#FFFFFF" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FFFFFF"></div>\n\
                                <div class="color" data-color="#FFB700" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FFB700"></div>\n\
                                <div class="color" data-color="#FF5300" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF5300"></div>\n\
                                <div class="color" data-color="#FF7600" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF7600"></div>\n\
                                <div class="color" data-color="#04819E" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#04819E"></div>\n\
                                <div class="color" data-color="#60B9CE" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#60B9CE"></div>\n\
                                <div class="color" data-color="#330570" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#330570"></div>\n\
                                <div class="color" data-color="#E266B7" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#E266B7"></div>\n\
                                <div class="color" data-color="#CD0074" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#CD0074"></div>\n\
                                <div class="color" data-color="#FF3100" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#FF3100"></div>\n\
                                <div class="color" data-color="#009999" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#009999"></div>\n\
                                <div class="color" data-color="#06276F" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#06276F"></div>\n\
                                <div class="color" data-color="#4573D5" data-id="' + id + '" data-name="' + name + '"  data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '"  style="background-color:#4573D5"></div>\n\
                                \n\
                                <div class="clear"></div>\n\
                                </div>\n\
				\n\
                <div  class="conf_item">Текст кнопки: <br /><input type="text" name="btn_title" id="btn_title" data-id="' + id + '" data-name="' + name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="' + btn_text + '" ></div>\n\
                    <div id="form_action"><div class="conf-wrap-title">Параметры формы</div>\n\
                        <div><input type="radio" ' + actions.thanks + ' name="action" data-id="' + id + '" data-name="' + name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="thanks"  > Окно благодарности <span id="edit_popup_thanks" data-id="' + id + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '">редактировать</span></div>\n\
                        <div><input type="radio" ' + actions.redirect + ' name="action" data-id="' + id + '" data-name="' + name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="redirect"> Переход по ссылке. (Вставьте ссылку, на которую отправить клиента после заполнения формы) <br />  <input type="text" name="url" data-id="' + id + '" data-name="' + name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="' + url + '"  /></div>\n\
                        <div><input type="radio" ' + actions.pay + ' name="action" data-id="' + id + '" data-name="' + name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="pay"> Платежная система. Cумма <input type="text" name="amount" data-id="' + id + '" data-name="' + name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="' +amount + '" /></div>\n\
                    </div></div>\n\
                ';
                  //      <div><input type="radio" ' + actions.subscription + ' name="action" data-id="' + id + '" data-name="' + name + '" data-var-box-id="' + var_box_id + '" data-var-box="' + var_box_name + '" value="subscription"> Почтовый сервис ( <a  target="_blank" href="/support/?article=podklyuchenie-justclick-na-sajt" title="Как настроить  JustClick">JustClick</a>, <a target="_blank" href="/support/?article=kak-podklyuchit-servis-smartresponder-k-svoemu-sajtu" title="Как настроить Smartresponder">SmartResponder</a> )</div>\n\
                
            
		OpenWindow('Настройка формы', html, 'form_config');
		$('#sort_box').sortable({
			placeholder: "ui-state-highlight",
			stop: function (event, ui) {
				var tmp = [];
				$('#window .field_editor').each(function (i) {
					if (var_box_name && var_box_name!='undefined') {
						tmp.push(_.clone(userBlock.data[var_box_name][var_box_id][name][$('#window .field_editor').eq(i).data('index')]));
					}else{
						tmp.push(_.clone(userBlock.data[name][$('#window .field_editor').eq(i).data('index')]));
					}
				})
				if (var_box_name && var_box_name!='undefined') {
					if (_.findWhere(userBlock.data[var_box_name][var_box_id][name], {type: 'btn'})) {
						tmp.push(_.findWhere(userBlock.data[var_box_name][var_box_id][name], {type: 'btn'}))
					}
					
					userBlock.data[var_box_name][var_box_id][name] = _.clone(tmp);
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
					if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
						$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
					}
					// fix
					RemoveWindow();
					$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('[data-editor="form"].'+name).click();					
					
				}else{
					if (_.findWhere(userBlock.data[name], {type: 'btn'})) {
						tmp.push(_.findWhere(userBlock.data[name], {type: 'btn'}))
					}

					userBlock.data[name] = _.clone(tmp);
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
					if($('#b_' + id).find('.'+name).size()){
						$('#b_' + id).find('.'+name).closest('.popup_form').show();
					}
					// fix
					RemoveWindow();
					$('#b_' + id).find('[data-editor="form"].'+name).click();
				}
				
				
				
				

				
			}
		});
	});
        
        
 
        
	$('body').on('click', '.field_editor_title', function () {
		$(this).parent().children('.field_editor_content').toggle();
	})
	$('body').on('click', '.field_editor_title i.fa-trash', function (event) {
		event.stopPropagation();
		
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name') + '';
		var index = $(this).parent().parent().data('index') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).parent().parent().data('varBox');
		var var_box_id = $(this).parent().parent().data('varBoxId');
		
		
		if (var_box_name && var_box_name!='undefined') {

			userBlock.data[var_box_name][var_box_id][name].splice(index,1);
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			RemoveWindow();
			$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('[data-editor="form"].'+name).click();
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
				$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}		
			
		
		} else {
			userBlock.data[name].splice(index,1);
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			RemoveWindow();
			$('#b_' + id).find('[data-editor="form"].'+name).click();
			if($('#b_' + id).find('.'+name).size()){
				$('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
			
			
		}		
		
		
		
		
		
	})
        
       
        
        
        
	$('body').on('click', '#edit_popup_thanks', function () {
		var id = $(this).data('id') + '';
		RemoveWindow();
		$('.popup_thanks').hide();
		$('.popup_form').hide();
		$('#b_' + id).find('.popup_thanks').show();
		
	})
	$('body').on('change', '#form_action input[name="action"]', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');
		
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].action = $('#form_action input[name="action"]:checked').val();
			$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('[data-editor="form"].'+name).click();
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
                        $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}			
		} else {
			userBlock.data[name][userBlock.data[name].length - 1].action = $('#form_action input[name="action"]:checked').val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}			
		
		
	})
	$('body').on('change', '#form_action input[name="amount"],#form_action input[name="url"] ', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1][$(this).attr('name')] = _.escape($(this).val());
			$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('[data-editor="form"].'+name).click();
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
				$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}				
		}else{
			userBlock.data[name][userBlock.data[name].length - 1][$(this).attr('name')] = _.escape($(this).val());
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}
		
	})
	$('body').on('click', '.form_config #btn_config .color', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].color = $(this).data('color');
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}	
			
		}else{
			userBlock.data[name][userBlock.data[name].length - 1].color = $(this).data('color');
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}
	})
	
	$('body').on('change', '.form_config #btn_surround', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
			if($(this).prop( "checked" )){
				userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].surround = 1;
			}else{
				userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].surround = 0;
			}
			
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}		
		}else{
			if($(this).prop( "checked" )){
				userBlock.data[name][userBlock.data[name].length - 1].surround = 1;
				
			}else{
				userBlock.data[name][userBlock.data[name].length - 1].surround = 0;
				
			}
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
				$('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}
		

	})	
	
	
	$('body').on('input', '.form_config #btn_title', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].title = _.escape($(this).val());
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}   	
		}else{
			userBlock.data[name][userBlock.data[name].length - 1].title = _.escape($(this).val());
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}		
	})
        
        
	$('body').on('change', '.form_config input[name="btn_style"]', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var val = $(this).val();
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].style = val;
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}   	
		}else{
			userBlock.data[name][userBlock.data[name].length - 1].style = val;
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}
	}) 
        
        


	$('body').on('change', '.form_config input[name="btn_shadow"]', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var val = $(this).val();
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name][userBlock.data[var_box_name][var_box_id][name].length - 1].shadow = val;
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}   	
		}else{
			userBlock.data[name][userBlock.data[name].length - 1].shadow = val;
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}
	})     
    
	
	$('body').on('click', '.field_type', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
		
				if ($(this).data('type') == 'text') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'text',
						title: 'Текстовое поле',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'email') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'email',
						title: 'E-mail',
						description: 'Введите E-mail',
						required: 0
					})
				} else if ($(this).data('type') == 'phone') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'phone',
						title: 'Телефон',
						description: 'Введите Телефон',
						required: 0
					})
				} else if ($(this).data('type') == 'list') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'list',
						title: 'Выпадающий список',
						description: '',
						required: 0,
						options: ['Первый', 'Второй']
					})
				} else if ($(this).data('type') == 'textarea') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'textarea',
						title: 'Текстовое поле',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'checkbox') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'checkbox',
						title: 'Галочка',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'radio') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'radio',
						title: 'Переключатель',
						description: '',
						required: 0,
						options: ['Первый', 'Второй']
					})
				} else if ($(this).data('type') == 'file') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'file',
						title: 'Файл',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'hidden') {
					userBlock.data[var_box_name][var_box_id][name].unshift({
						type: 'hidden',
						title: 'Название формы',
						description: '',
						required: 0
					})
				}
				
				$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                App.events.afterBlockRender(id);
				RemoveWindow();
				
				
				$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('[data-editor="form"].'+name).click();

				if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
					$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
				}	


			
			
		}else{
			
		
				if ($(this).data('type') == 'text') {
					userBlock.data[name].unshift({
						type: 'text',
						title: 'Текстовое поле',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'email') {
					userBlock.data[name].unshift({
						type: 'email',
						title: 'E-mail',
						description: 'Введите E-mail',
						required: 0
					})
				} else if ($(this).data('type') == 'phone') {
					userBlock.data[name].unshift({
						type: 'phone',
						title: 'Телефон',
						description: 'Введите Телефон',
						required: 0
					})
				} else if ($(this).data('type') == 'list') {
					userBlock.data[name].unshift({
						type: 'list',
						title: 'Выпадающий список',
						description: '',
						required: 0,
						options: ['Первый', 'Второй']
					})
				} else if ($(this).data('type') == 'textarea') {
					userBlock.data[name].unshift({
						type: 'textarea',
						title: 'Текстовое поле',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'checkbox') {
					userBlock.data[name].unshift({
						type: 'checkbox',
						title: 'Галочка',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'radio') {
					userBlock.data[name].unshift({
						type: 'radio',
						title: 'Переключатель',
						description: '',
						required: 0,
						options: ['Первый', 'Второй']
					})
				} else if ($(this).data('type') == 'file') {
					userBlock.data[name].unshift({
						type: 'file',
						title: 'Файл',
						description: '',
						required: 0
					})
				} else if ($(this).data('type') == 'hidden') {
					userBlock.data[name].unshift({
						type: 'hidden',
						title: 'Название формы',
						description: '',
						required: 0
					})
				}
				$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                App.events.afterBlockRender(id);
				RemoveWindow();

				$('#b_' + id).find('[data-editor="form"].'+name).click();

				if($('#b_' + id).find('.'+name).size()){
					$('#b_' + id).find('.'+name).closest('.popup_form').show();
				}			
		}		
		
	
	})
	$('body').on('input', '.form_config .field_editor_content input, .form_config .field_editor_content textarea', function () {
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name');
		var index = $(this).parent().parent().data('index');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).parent().parent().data('varBox');
		var var_box_id = $(this).parent().parent().data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
			
			if ($(this).prop('tagName') == 'TEXTAREA') {
				userBlock.data[var_box_name][var_box_id][name][index][$(this).attr('name')] = _.escape($(this).val()).split('\n');
			} else {
				userBlock.data[var_box_name][var_box_id][name][index][$(this).attr('name')] = _.escape($(this).val());
			}
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}				
			
		}else{
			if ($(this).prop('tagName') == 'TEXTAREA') {
				userBlock.data[name][index][$(this).attr('name')] = _.escape($(this).val()).split('\n');
			} else {
				userBlock.data[name][index][$(this).attr('name')] = _.escape($(this).val());
			}
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}		
	})
	$('body').on('change', '.form_config .field_editor_content [type="checkbox"]', function () {
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name');
		var index = $(this).parent().parent().data('index');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var var_box_name = $(this).parent().parent().data('varBox');
		var var_box_id = $(this).parent().parent().data('varBoxId');			
		if (var_box_name && var_box_name!='undefined') {
			
			if ($(this).attr('type') == 'checkbox') {
				
				if ($(this).prop('checked')) {
					userBlock.data[var_box_name][var_box_id][name][index][$(this).attr('name')] = 1;
				} else {
					userBlock.data[var_box_name][var_box_id][name][index][$(this).attr('name')] = 0;
				}
			}
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).closest('.popup_form').show();
			}				
			
		}else{
			if ($(this).attr('type') == 'checkbox') {
				if ($(this).prop('checked')) {
					userBlock.data[name][index][$(this).attr('name')] = 1;
				} else {
					userBlock.data[name][index][$(this).attr('name')] = 0;
				}
			} 
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).closest('.popup_form').show();
			}		
		}		
	})
	//редактор меню
	$('#wrapper').on('click', '[data-editor="menu"]', function (){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var html = '<div id="sort_mneu">';
		var k = 0;
		_.each(userBlock.data[name], function (i) {
                        var level = 0;
                        if (typeof(i.level)==='undefined'){
                        } else{
                            level = i.level;
                        }

                    
			html += '<div class="field_menu_editor level'+level+'" data-id="' + id + '" data-name="' + name + '" data-index="' + k + '">';
			html += '<div class="field_menu_editor_title">' + i.title + ' <i class="fa fa-chevron-circle-left"></i> <i class="fa fa-chevron-circle-right"></i> <i class="fa fa-trash"></i></div>';
			html += '<div class="field_menu_editor_content">Название: <input type="text" value="' + i.title + '" name="title">Ссылка или <a href="https://tobiz.net/support/?article=kak-stavit-yakor-na-odnostranichnyj-sajt" target="_blank">якорь</a>: <input type="text" value="' + i.link + '" name="link"> <i class="fa fa-link linklib"></i><div class="linklib_variants"></div></div>';
			html += '</div>';
			k++;
		})		
		html += '</div>';
		html += '<div id="add_field_menu" data-id="'+id+'" data-name="'+name+'">Добавить пункт меню</div>';
		OpenWindow('Настройка меню', html, 'menu_config');
		$('#sort_mneu').sortable({
			placeholder: "ui-state-highlight",
			stop: function (event, ui) {
				var tmp = [];
				$('#window .field_menu_editor').each(function (i) {
					tmp.push(_.clone(userBlock.data[name][$('#window .field_menu_editor').eq(i).data('index')]));
				})
				userBlock.data[name] = _.clone(tmp);

				$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
				App.events.afterBlockRender(id);
				// fix
				RemoveWindow();
				$('#b_' + id).find('[data-editor="menu"].'+name).click();
			}
		});		
		
		
	})
	$('body').on('click', '.field_menu_editor_title i.fa-trash', function (event) {
		event.stopPropagation();
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name') + '';
		var index = $(this).parent().parent().data('index') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data[name].splice(index,1);
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
		App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="menu"].'+name).click();
		
	})
	$('body').on('click', '.field_menu_editor_title i.fa-chevron-circle-left', function (event) {
		event.stopPropagation();
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name') + '';
		var index = $(this).parent().parent().data('index') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data[name][index]['level'] = 0 ;
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
		App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="menu"].'+name).click();
		
	})
	$('body').on('click', '.field_menu_editor_title i.fa-chevron-circle-right', function (event) {
		event.stopPropagation();
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name') + '';
		var index = $(this).parent().parent().data('index') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data[name][index]['level'] = 1 ;
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
		App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="menu"].'+name).click();
		
	})
	$('body').on('click', '.field_menu_editor_title', function () {
		$(this).parent().children('.field_menu_editor_content').toggle();
	})
	$('body').on('input', '.field_menu_editor_content input', function () {
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name');
		var index = $(this).parent().parent().data('index');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data[name][index][$(this).attr('name')] = _.escape($(this).val());
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
		App.events.afterBlockRender(id);
	})	
	$('body').on('click', '#add_field_menu', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
			userBlock.data[name].unshift({
				title: 'Новый пункт меню',
				link: '#anchor'
			})
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="menu"].'+name).click();
	})

	//редактор изображений
	$('#wrapper').on('click','[data-editor="image"]',function(){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
                var descr_size ='';
                var model = _.clone(_.findWhere(App.blocks, {type_id: userBlock.type_id * 1}));
            
            
            
		if (var_box_name && var_box_name!='undefined') {
                    var var_info = _.findWhere(model.var_boxs[0].vars, {name: name});
                    
                    if(typeof var_info != 'undefined' && typeof var_info.descr_size != 'undefined'){
                        descr_size = '<div class="image_size">Рекомендуемый размер изображения ' +var_info.descr_size+'px (*.png/*.jpg) </div>';
                    }
            
            
                }else{
		
                
                    var var_info = _.findWhere(model.vars, {name: name});
                    if(typeof var_info != 'undefined' && typeof var_info.descr_size != 'undefined'){
                        descr_size = '<div class="image_size">Рекомендуемый размер изображения ' +var_info.descr_size+'px (*.png/*.jpg) </div>';
                    }
                
		}            
            
                
		var html = '';
                
                if(var_box_name && var_box_name!='undefined'){
                    
                    
                    if(userBlock.data[var_box_name][var_box_id][name]!="undefined" && userBlock.data[var_box_name][var_box_id][name]){
                            html += '<div><img src="/img/200x0/'+userBlock.data[var_box_name][var_box_id][name]+'" alt=""></div>'+descr_size;
                    }
                    
                }else{
                    if(userBlock.data[name]!="undefined" && userBlock.data[name]){
                            html += '<div><img src="/img/200x0/'+userBlock.data[name]+'" alt=""></div>'+descr_size;
                    }
                }
                
                
		
		html += '<div><form id="image_upload" enctype="multipart/form-data" data-id="'+id+'" data-name="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'"  ><input type="hidden" name="block_id" value="'+id+'" /><input type="file" name="image"><input type="submit" value="Загрузить" /></form></div>';
		html += '</div>';
		OpenWindow('Настройка изображения', html, 'image_config');		
	})
	$('body').on('submit', '#image_upload', function(event){
		event.preventDefault();
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		
		var userBlock = _.findWhere(App.userBlocks, {id: id});	
		var data_send = new FormData($(this)[0]);
		$.ajax({dataType: "json", 
			type: "POST", 
			url: "https://tobiz.net/system/editor/upload.php", 
			data: data_send, 
			cache: false, 
			contentType: false, 
			processData: false,
			success: function(data){
				if (data.status == 'OK') {

					if(var_box_name && var_box_name!='undefined'){
						userBlock.data[var_box_name][var_box_id][name]= data.image;
						
					}else{
						userBlock.data[name]= data.image;
						
					}
                                        var ii = -1;
                                        
                                        
                                        if($('.extra_info_block_wrapper').size()){
                                            $('.extra_info_block_wrapper').each(function(i){
                                                if($(this).is(":visible")){
                                                    ii = i;
                                                }
                                            })
                                        }
					
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
                                        if(ii>=0){
                                            $('.extra_info_block_wrapper').eq(ii).show();
                                        }
                                        					
					
					RemoveWindow();		
				} else {
					alert(data.msg);
				}				
				
			}})
		})		
	//редактор imagebox-editor

	$('#wrapper').on('click','[data-editor="image_box"]',function(){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var img_title = '' ,img_descr ='' , img_way='', img_link='';
                
                
                
                var descr_size ='';
                var model = _.clone(_.findWhere(App.blocks, {type_id: userBlock.type_id * 1}));
            
            
            
                 
                
                
                
                
		if(var_box_name && var_box_name!='undefined'){
			img_title =userBlock.data[var_box_name][var_box_id][name].title;
			img_descr =userBlock.data[var_box_name][var_box_id][name].descr;
			img_way =userBlock.data[var_box_name][var_box_id][name].image;

                        if(typeof userBlock.data[var_box_name][var_box_id][name].link !== 'undefined'){
                            img_link =userBlock.data[var_box_name][var_box_id][name].link;
                        }
                        
                        var var_info = _.findWhere(model.var_boxs[0].vars, {name: name});
                        if(typeof var_info != 'undefined' && typeof var_info.descr_size != 'undefined'){
                            descr_size = '<div class="image_size">Рекомендуемый размер изображения ' +var_info.descr_size+'px (*.png/*.jpg) </div>';
                        }
                        
                        
		}else{
			img_title =userBlock.data[name].title;
			img_descr =userBlock.data[name].descr;
			img_way =userBlock.data[name].image;
                        
                        
                        
                        if(typeof userBlock.data[name].link !== 'undefined'){
                            img_link =userBlock.data[name].link;
                        }
                        
                        
                        var var_info = _.findWhere(model.vars, {name: name});
                        if(typeof var_info != 'undefined' && typeof var_info.descr_size != 'undefined'){
                            descr_size = '<div class="image_size">Рекомендуемый размер изображения ' +var_info.descr_size+'px (*.png/*.jpg) </div>';
                        }
                        
                        
		}
                

                
		var html = '';
                if(userBlock.type_id!=310){
                    
                    html += '<div>Заголвок:<br /> <input type="text" id="image_box_title" value="'+img_title+'" data-id="'+id+'" data-name="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'" /> </div>';
                    html += '<div>Описание:<br /> <input type="text" id="image_box_descr" value="'+img_descr+'" data-id="'+id+'" data-name="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'" /> </div>';
                    html += '<div>Ссылка:<br /> <input type="text" name="link" id="image_box_link" value="'+img_link+'" data-id="'+id+'" data-name="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'" /> <i class="fa fa-link linklib"></i><div class="linklib_variants"></div></div>';
                }
                
		html += '<div><br /><img src="/img/0x150/'+img_way+'" alt=""></div>'+descr_size;
		html += '<div><form id="image_box_upload" enctype="multipart/form-data" data-id="'+id+'" data-name="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'"   ><input type="hidden" name="block_id" value="'+id+'"  /><input type="file" name="image"><input type="submit" value="Загрузить" /></form></div>';
		html += '</div>';
		OpenWindow('Настройка изображения', html, 'image_box_config');		
	})	
	
	$('body').on('change', '#image_box_title',function(){
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		var userBlock = _.findWhere(App.userBlocks, {id: id});	
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name].title = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
				$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).click();
			}	
		}else{
			userBlock.data[name].title = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
				$('#b_' + id).find('.'+name).click();
			}		
		}		
	})
	$('body').on('change', '#image_box_descr',function(){
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		var userBlock = _.findWhere(App.userBlocks, {id: id});	
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name].descr = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
				$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).click();
			}	
		}else{
			userBlock.data[name].descr = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
				$('#b_' + id).find('.'+name).click();
			}		
		}		
	})
	$('body').on('change', '#image_box_link',function(){
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		var userBlock = _.findWhere(App.userBlocks, {id: id});	
		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name].link = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
                            $('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).click();
			}	
		}else{
			userBlock.data[name].link = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
                            $('#b_' + id).find('.'+name).click();
			}		
		}		
	})

	$('body').on('submit', '#image_box_upload', function(event){
		event.preventDefault();
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		
		var userBlock = _.findWhere(App.userBlocks, {id: id});	
		var data_send = new FormData($(this)[0]);
		$.ajax({dataType: "json", 
			type: "POST", 
			url: "https://tobiz.net/system/editor/upload.php", 
			data: data_send, 
			cache: false, 
			contentType: false, 
			processData: false,
			success: function(data){
				if (data.status == 'OK') {
					if(var_box_name  && var_box_name!='undefined'){
						userBlock.data[var_box_name][var_box_id][name].image= data.image;
					}else{
						userBlock.data[name].image= data.image;
					}
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
					RemoveWindow();		
				} else {
					alert(data.msg);
				}				
			}})
		})
	
	
	
	

	// редактор видео.
	$('#wrapper').on('click','[data-editor="video"]',function(){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');

		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
		
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var link = '';
		if (var_box_name && var_box_name!='undefined') {
			link = userBlock.data[var_box_name][var_box_id][name]
		}else{
			link = userBlock.data[name];
		}		
		var html = '';
		html += '<div class="field_editor_content">Ссылка на видео (YouTube): <br /><input type="text" id="video_link" value="'+link+'" data-id="'+id+'" data-name="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'"></div>';
		html += '<div class="remark">Что бы видео загружалось исправно, прочитайте  <a href="https://tobiz.net/support/?article=kak-zagruzit-kartinku-v-video-youtube-na-sajte">инструкцию</a>.</div>';
		OpenWindow('Укажите ссылку на видео', html, 'video_config');		
		
	})
	$('body').on('change', '#video_link', function(event){
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		
		var userBlock = _.findWhere(App.userBlocks, {id: id});	


		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name] = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
				$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).click();
			}	
		}else{
			userBlock.data[name] = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
				$('#b_' + id).find('.'+name).click();
			}		
		}

	})
        
        
        // редактор ссылки (простой)
        
	$('#wrapper').on('click','[data-editor="link"]',function(e){
            
                e.preventDefault();
            
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');

		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
		
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		var link = '';
		if (var_box_name && var_box_name!='undefined') {
			link = userBlock.data[var_box_name][var_box_id][name]
		}else{
			link = userBlock.data[name];
		}		
		var html = '';
		html += '<div class="field_editor_content">Ссылка: <br /><input type="text" id="link_link" value="'+link+'" data-id="'+id+'" data-name="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'"></div>';
		OpenWindow('Укажите ссылку', html, 'link_config');		
		
	})
	$('body').on('change', '#link_link', function(event){
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		
		var var_box_name = $(this).data('varBox');
		var var_box_id = $(this).data('varBoxId');		
		
		var userBlock = _.findWhere(App.userBlocks, {id: id});	


		if (var_box_name && var_box_name!='undefined') {
			userBlock.data[var_box_name][var_box_id][name] = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).size()){
				$('#b_' + id).find('.'+var_box_name).eq(var_box_id).find('.'+name).click();
			}	
		}else{
			userBlock.data[name] = $(this).val();
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			if($('#b_' + id).find('.'+name).size()){
				$('#b_' + id).find('.'+name).click();
			}		
		}

	})        
        
        
	// Редактор HTML
	
	$('#wrapper').on('click','[data-editor="html"]',function(){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
                
		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');

            
		var code = '';
		if (var_box_name && var_box_name!='undefined') {
                    code = userBlock.data[var_box_name][var_box_id][name]
		}else{
                    code = userBlock.data[name];
		}            
            
		var html = '';
		html += '<textarea id="cm_editor" data-id="'+id+'" data="'+name+'" data-var-box="'+var_box_name+'" data-var-box-id="'+var_box_id+'">'+code+'</textarea>';
		html += '<button id="cm_save">Сохранить</button>';
		
		$.ajax({
		  url: '/js/cm.js',
		  dataType: "script",
		  cache: true,
		  success: function(){
				OpenWindow('Редактор HTML', html, 'html_config');	
				var cm_editor = CodeMirror.fromTextArea($('#cm_editor')[0], {
					lineNumbers: true,
					mode: "htmlmixed"
				});
				$('body').on('click', '#cm_save', function () {
                                    
                                        if (var_box_name && var_box_name!='undefined') {
                                            userBlock.data[var_box_name][var_box_id][name] = cm_editor.getValue();
                                        }else{
                                            userBlock.data[name]=cm_editor.getValue();
                                        } 					
                                    
                                        
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
                                        RemoveWindow();
				})		  
		  }
		});		
		

	
		
	})
	
	
	// Редактор карты
	$('#wrapper').on('click','[data-editor="map"]',function(){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});		
		
		var html ='';
		var placemark = new Array();
		_.each(userBlock.data[name], function (i,num) {
			html += '<div class="field_map_editor" data-id="' + id + '" data-name="' + name + '" data-index="'+num+'">';
			html += '<div class="field_map_title">' + i.address + ' <i class="fa fa-trash"></i></div>';
			html += '<div class="field_map_content">Адрес: <input type="text" value="' + i.address + '" name="address">';
			var colors = ['#0187BC', '#3E9802','#FD6F00', '#8C33D2', '#9581BF','#9581BF','#F372A4', '#CE0707', '#FFC415'];
			html += '<br />Цвет: <div class="map_point_color">';
			_.each(colors, function(k){
				var selected = '';
				
				
				if(k==userBlock.data[name][num].color) {
					selected = 'selected';
				}
				html += '<div class="color '+selected+'" data-color="'+k+'" data-id="' + id + '" data-name="' + name + '"  style="background-color:'+k+'"></div>';
			})
			html += '<div class="clear"></div>';
			html += '</div></div></div>';
		})			
		
		html += '<div id="add_map_address" data-id="' + id + '" data-name="' + name + '">Добавить новый адрес</div>';
		html +='<div id="editor_map" style="width:600px; height:350px;"></div>';
		OpenWindow('Редактор карты', html, 'map_config');	
		
			
			ymaps.ready(function(){


				var center = _.cloneDeep(userBlock.data.map_center);
				center.controls = ["zoomControl"];
				var MAP = new ymaps.Map("editor_map", center);
				MAP.events.add('actionend', function(){
					userBlock.data.map_center.center = MAP.getCenter();
					userBlock.data.map_center.zoom = MAP.getZoom();
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
				})		
				setTimeout(function(){
					_.each(userBlock.data[name], function (i,num) {
						var myGeocoder = ymaps.geocode(i.address);
						myGeocoder.then(
							function (res) {
								var myPlacemark = new ymaps.Placemark(res.geoObjects.get(0).geometry.getCoordinates(),{},{
									preset: 'islands#icon',
									iconColor: i.color
								});
								MAP.geoObjects.add(myPlacemark);	
							},
							function (err) {
								
							}
						);
					})
				},300);

			})
	})

	$('body').on('click', '.field_map_title i.fa-trash', function (event) {
		event.stopPropagation();
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name') + '';
		var index = $(this).parent().parent().data('index') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data[name].splice(index,1);
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="map"].'+name).click();
		
	})
	$('body').on('click', '.field_map_title', function () {
		$(this).parent().children('.field_map_content').toggle();
	})
	
	$('body').on('change', '.field_map_content input', function () {
		var id = $(this).parent().parent().data('id') + '';
		var name = $(this).parent().parent().data('name');
		var index = $(this).parent().parent().data('index');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data[name][index][$(this).attr('name')] = _.escape($(this).val());
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="map"].'+name).click();
		$('.field_map_title').eq(index).click();
		
	})	
	$('body').on('click', '.field_map_content .color', function () {
		var id = $(this).parent().parent().parent().data('id') + '';
		var name = $(this).parent().parent().parent().data('name');
		var index = $(this).parent().parent().parent().data('index');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.data[name][index].color = $(this).data('color');
		$(this).parent().children('.color').removeClass('selected');
		$(this).addClass('selected');
		
		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="map"].'+name).click();
		$('.field_map_title').eq(index).click();
	
	})	
	$('body').on('click', '#add_map_address', function () {
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
			userBlock.data[name].unshift({
				address: 'Москва',
				color: '#CE0707'
			})
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		RemoveWindow();
		$('#b_' + id).find('[data-editor="map"].'+name).click();
	})	
	
	
	
	// Редактор таймера
	$('#wrapper').on('click','[data-editor="timer"]',function(){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');

		var userBlock = _.findWhere(App.userBlocks, {id: id});
		
		
		
		
		var html = '';
		html += '<div class="field_editor_content">Тип таймера: <br />';
		var arr = [
			{
				name:'date',
				title:'Точая дата'
			},
//			{
//				name:'monthly',
//				title:'Ежемесячно'
//			},
//			{
//				name:'weekly',
//				title:'Еженедельно'
//			},
			{
				name:'daily',
				title:'Ежедневно'
			}

		];
		_.each(arr, function(i){
			var checked ='';
			if(userBlock.data[name].type==i.name){
				checked ='checked="checked"';
			}
			html += '<div class="conf_item"><input type="radio" value="'+i.name+'" data-id="'+id+'" data-name="'+name+'" name="timer_type" '+checked+' > '+i.title+' </div>';
		})
		html += '<div class="conf_item">';
		
                html += '<div class="conf_item">';
		if(userBlock.data[name].type=='monthly' || userBlock.data[name].type=='date'){

			
			html += 'Дата: <select data-id="'+id+'" data-name="'+name+'" name="dd">';
			var selected ='';
			for(i=1; i<=31; i++){
				selected = '';

				if(parseInt(userBlock.data[name].dd)==i){
					selected = 'selected="selected"';
				}
				html += '<option '+selected+' value="'+i+'">'+i+'</option>';

			}
			html += '</select>';			
			
		}			
		if(userBlock.data[name].type=='date'){
			html += '';
			
			html += 'Месяц: <select data-id="'+id+'" data-name="'+name+'" name="dm">';
			var m_arr = ['Январь', 'Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
			_.each(m_arr,function(element,index){
				var selected ='';
				
				if((index+1)==userBlock.data[name].dm){
					selected = 'selected="selected"';
				}
				html += '<option '+selected+' value="'+(index+1)+'">'+element+'</option>';
			})
			html += '</select>';
			
			
			html += 'Год: <select data-id="'+id+'" data-name="'+name+'" name="dy">';
			var y_arr = ['2015', '2016','2017','2018','2019','2020','2021','2022','2023','2024','2025','2026'];
			_.each(y_arr,function(element,index){
				var selected ='';
				
				if(element==userBlock.data[name].dy){
					selected = 'selected="selected"';
				}
				html += '<option '+selected+' value="'+element+'">'+element+'</option>';
			})
			html += '</select>';
			

		}
                html += '</div>';

		if(userBlock.data[name].type=='weekly'){
			html += 'День недели: <select data-id="'+id+'" data-name="'+name+'" name="weekly">';
			var w_arr = ['Понедельник', 'Вторник','Среда','Четверг','Пятница','Суббота','Воскресенье'];
			_.each(w_arr,function(element,index){
				var selected ='';
				
				if((index+1)==userBlock.data[name].weekly){
					selected = 'selected="selected"';
				}
				html += '<option '+selected+' value="'+(index+1)+'">'+element+'</option>';
			})
			html += '</select>';
		}
		html += '<div class="conf_item">';
		
		html += 'Часы: <select data-id="'+id+'" data-name="'+name+'" name="hr">';
		var selected ='';
		for(i=0; i<=23; i++){
			selected = '';

			if(parseInt(userBlock.data[name].hr)==i){
				selected = 'selected="selected"';
			}
			html += '<option '+selected+' value="'+i+'">'+i+'</option>';

		}
		html += '</select>';

		html += ' Минуты: <select data-id="'+id+'" data-name="'+name+'" name="min">';
		var selected ='';
		for(i=0; i<=50; i+=10){

			selected = '';
			if(parseInt(userBlock.data[name].min)==i){
				selected = 'selected="selected"';
			}
			html += '<option '+selected+' value="'+i+'">'+i+'</option>';

		}
		html += '</select>';
		html += '</div>';

		if(userBlock.data[name].type=='date'){

			html += '<div class="remark">Примечание: Когда таймер закончится, блок будет автоматически скрыт.</div>';			
			
		}			

		
		OpenWindow('Настройки таймера', html, 'timer_config');		
		
	})	
	
	
	$('body').on('change','.timer_config [name="timer_type"]', function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');		
		userBlock.data[name].type = $(this).val();
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		if($('#b_' + id).find('.'+name).size()){
			$('#b_' + id).find('.'+name).click();
		}		
	})
	$('body').on('change','.timer_config select', function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');		
		userBlock.data[name][$(this).attr('name')] = $(this).val();
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		if($('#b_' + id).find('.'+name).size()){
			$('#b_' + id).find('.'+name).click();
		}		
	})





	//редактор логотипа
	$('#wrapper').on('click','[data-editor="logo"]',function(){
		var id = $(this).closest('.section').data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var html = '';

		if((userBlock.data[name].use_image*1)==1){
			html += '<div><input type="radio" name="use_image" data-id="'+id+'" data-name="'+name+'" value="0"  /> Текст</div>';
			html += '<div><input type="radio" name="use_image" data-id="'+id+'" data-name="'+name+'"  value="1" checked="checked" /> Изображение</div>';
			html += '<div><form id="logo_upload" enctype="multipart/form-data" data-id="'+id+'" data-name="'+name+'"><input type="hidden" name="block_id" value="'+id+'" /><input type="file" name="image"><input type="submit" value="Загрузить" /></form></div>';
			html += '<div>Размер изображения:</div>';
			html += '<div><input type="range" min="'+userBlock.data[name].min_image_size+'" max="'+userBlock.data[name].max_image_size+'" step="10" name="image_size" data-id="'+id+'" data-name="'+name+'"  value="'+userBlock.data[name].image_size+'"  /></div>';
		}else{
			html += '<div><input type="radio" name="use_image" data-id="'+id+'" data-name="'+name+'"  value="0" checked="checked" /> Текст</div>';
			html += '<div><input type="radio" name="use_image" data-id="'+id+'" data-name="'+name+'"  value="1"  /> Изображение</div>';

			html += '<div>Название компании:</div>';
			html += '<div><input type="text" name="title" data-id="'+id+'" data-name="'+name+'"  value="'+userBlock.data[name].title+'"  /></div>';

			html += '<div>Размер шрифта:</div>';
			html += '<div><input type="range" min="14" max="36" step="1" name="text_size" data-id="'+id+'" data-name="'+name+'"  value="'+userBlock.data[name].font_size+'"  /></div>';

			html += '<div>Шрифт:</div>';
			var fonts=['Arial','Calibri','Georgia','Tahoma','Times New Roman','Trebuchet MS','Verdana']
			html += '<div><select name="font" data-id="'+id+'" data-name="'+name+'">';
				_.each(fonts, function(f){
					if(f==userBlock.data[name].font){
						html += '<option selected="selected" value="'+f+'">'+f+'</option>';
					}else{
						html += '<option value="'+f+'">'+f+'</option>';
					}
				})
				
			var bold = '', italic='';
			if(parseInt(userBlock.data[name].bold)) bold="active";
			if(parseInt(userBlock.data[name].italic)) italic="active";
		
			html += '</select> <input type="color" name="color" data-id="'+id+'" data-name="'+name+'"  value="'+userBlock.data[name].color+'"  /> <span class="bold '+bold+'" data-id="'+id+'" data-name="'+name+'">B</span> <span class="italic '+italic+'" data-id="'+id+'" data-name="'+name+'">I</span> </div>';
		}
		html += '</div>';
		OpenWindow('Редактор логотипа', html, 'logo_config');				
	})

	$('body').on('click', '.logo_config .bold,.logo_config .italic ',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');
		
		
		var v = 0;
		if($(this).hasClass('bold')){
			if(!$(this).hasClass('active')) v=1;
			userBlock.data[name].bold = v;
		}
		if($(this).hasClass('italic')){
			if(!$(this).hasClass('active')) v=1;
			userBlock.data[name].italic = v;
		}
		
		
		
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		if($('#b_' + id).find('.'+name).size()){
			$('#b_' + id).find('.'+name).click();
		}		
	})
	$('body').on('change', '.logo_config input[name="use_image"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');
		userBlock.data[name].use_image = $(this).val();
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		if($('#b_' + id).find('.'+name).size()){
			$('#b_' + id).find('.'+name).click();
		}		
	})
	$('body').on('input', '.logo_config input[name="title"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');
		userBlock.data[name].title = _.escape($(this).val());
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		
	})
	$('body').on('change', '.logo_config select[name="font"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');
		userBlock.data[name].font = _.escape($(this).val());
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	$('body').on('change', '.logo_config input[name="color"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');
		userBlock.data[name].color = _.escape($(this).val());
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	$('body').on('input', '.logo_config input[name="text_size"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');
		userBlock.data[name].text_size = _.escape($(this).val());
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	$('body').on('change', '.logo_config input[name="image_size"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var name = $(this).data('name');
		userBlock.data[name].image_size = _.escape($(this).val());
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	$('body').on('submit', '#logo_upload', function(event){
		event.preventDefault();
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});	
		var data_send = new FormData($(this)[0]);
		$.ajax({dataType: "json", 
			type: "POST", 
			url: "https://tobiz.net/system/editor/upload.php", 
			data: data_send, 
			cache: false, 
			contentType: false, 
			processData: false,
			success: function(data){
				if (data.status == 'OK') {
					userBlock.data[name].image= data.image;
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
					RemoveWindow();		
				} else {
					alert(data.msg);
				}				
				
			}})
	})	
	
	
	

	// редактор настроек блока
	$('#wrapper').on('click', '[data-conf]', function () {
		var id = $(this).closest('.section').data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var conf_html = '';
		var model = _.clone(_.findWhere(App.blocks, {type_id: userBlock.type_id * 1}));
                
                conf_html+='<div class="section_id">ID секции: '+id+'</div>';
                
                conf_html+='<div class="conf-wrap">';
                
		$.each(model.settings, function (index) {
			if (model.settings[index].type == 'separator') {
				conf_html += '<div class="separator"></div>'
			}
                        if (model.settings[index].type == 'subtitle') {
                            
                                if(index>1){
                                    
                                    conf_html += '</div><div class="conf-wrap">';
                                }
				
                                conf_html += '<div class="subtitle">'+model.settings[index].title+'</div>'
			}
                        if (model.settings[index].type == 'checkbox') {
				var checked = '';
				if (userBlock.data[model.settings[index].name] == 1)
					checked = 'checked="checked"';
				conf_html += '<div class="conf_item x_'+model.settings[index].name+'" ><input type="checkbox" data-settings="' + id + '" value="1" data-type="checkbox" data-name="' + model.settings[index].name + '"  ' + checked + ' name="' + model.settings[index].name + '" >  ' + model.settings[index].title + '</div>'
			}
                        if (model.settings[index].type == 'int') {
				conf_html += '<div class="conf_item x_'+model.settings[index].name+'" >' + model.settings[index].title + '<br /><input type="text" data-settings="' + id + '" value="'+ parseInt(userBlock.data[model.settings[index].name])+'" data-type="int" data-name="' + model.settings[index].name + '"  name="' + model.settings[index].name + '" >  </div>'
			}
                        if (model.settings[index].type == 'txt') {
				conf_html += '<div class="conf_item x_'+model.settings[index].name+'" >' + model.settings[index].title + '<br /><input type="text" data-settings="' + id + '" value="'+ userBlock.data[model.settings[index].name]+'" data-type="txt" data-name="' + model.settings[index].name + '"  name="' + model.settings[index].name + '" >  </div>'
			}
			if (model.settings[index].type == 'youtube') {
				conf_html += '<div class="conf_item">'+model.settings[index].title+'<input type="text" data-settings="' + id + '" value="'+userBlock.data[model.settings[index].name]+'" data-type="youtube" data-name="' + model.settings[index].name + '"  name="' + model.settings[index].name + '" > </div>'
			}
			
			
			if (model.settings[index].type == 'image_gallery') {
				conf_html += '<div class="conf_item">' + model.settings[index].title + '<br />';
				conf_html += '<div class="image_gallery" data-editor="image_gallery" data-id="'+id+'" data-name="'+model.settings[index].name+'" ><img src="/img/260x70/'+userBlock.data[model.settings[index].name]+'" /></div>';
				conf_html += '<div class="clear"></div>';
				conf_html += '</div>';
			}
			if (model.settings[index].type == 'colors') {
				conf_html += '<div class="conf_item">' + model.settings[index].title + '<br />';
				$.each(model.settings[index].vars, function (i) {
					var color = model.settings[index].vars[i];
					var content = '';
					if(color=='inherit'){
						content='auto';
					}
					var selected = '';
					if(userBlock.data[model.settings[index].name]==model.settings[index].vars[i]){
						selected = 'selected';
					}
					conf_html += '<div class="color '+selected+'" style="background:' + color + '" data-settings="' + id + '"  data-value="' + model.settings[index].vars[i] + '" data-type="colors" data-name="' + model.settings[index].name + '">'+content+'</div>';
				})
				conf_html += '<div class="clear"></div>';
				conf_html += '</div>';
			}
			if (model.settings[index].type == 'pattern') {
				conf_html += '<div class="conf_item"><div class="spoiler-title">' + model.settings[index].title + '</div><div class="spoiler-content">';
				$.each(model.settings[index].vars, function (i) {
					conf_html += '<div class="pattern" style="background-image: url(/img/' + model.settings[index].vars[i] + ')" data-settings="' + id + '"  data-value="' + model.settings[index].vars[i] + '" data-type="pattern" data-name="' + model.settings[index].name + '"></div>';
				})
				conf_html += '<div class="clear"></div></div>';
				conf_html += '</div>';
			}
			if (model.settings[index].type == 'background') {
				conf_html += '<div class="conf_item"><div class="spoiler-title">' + model.settings[index].title + '</div><div class="spoiler-content">';
				$.each(model.settings[index].vars, function (i) {
					conf_html += '<div class="background" style="" data-settings="' + id + '"  data-value="' + model.settings[index].vars[i] + '" data-type="background" data-name="' + model.settings[index].name + '">'+i+'</div>';
				})
				conf_html += '<div class="clear"></div></div>';
				conf_html += '</div>';
			}
			if (model.settings[index].type == 'radio') {
				conf_html += '<div class="conf_item">' + model.settings[index].title + '</div>';
				$.each(model.settings[index].vars, function (i) {
					var checked = '';
					if (userBlock.data[model.settings[index].name] == model.settings[index].vars[i].val)
						checked = 'checked="checked"';
					conf_html += '<div class="conf_item padding-left15">\n\
										<input \n\
											'+checked+' \n\
											type="radio" \n\
											data-settings="' + id + '" \n\
											data-type="radio" \n\
											data-name="' + model.settings[index].name + '" \n\
											name="'+model.settings[index].name+'" \n\
											data-value="' + model.settings[index].vars[i].val + '" \n\
											value="' + model.settings[index].vars[i].val + '" /> '+model.settings[index].vars[i].title+'</div>';
				})
				conf_html += '<div class="clear"></div>';
				//conf_html += '</div>';
			}
		});
                
                conf_html+='</div>';
                
		conf_html += '<div id="anchor_editor"><a href="https://tobiz.net/support/?article=kak-stavit-yakor-na-odnostranichnyj-sajt" target="_blank">Якорь</a>: <input type="text" data-id="'+id+'" name="anchor" value="'+userBlock.data.anchor+'" pattern="^[a-zA-Z][a-zA-Z0-9_]+$"></div>';
		OpenWindow('Настройки секции', conf_html, 'section_config')
	});
	$('#wrapper').on('click', '[data-kill]', function () {
		var id = $(this).closest('.section').data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		userBlock.deleted = "1";
		$(this).closest('.section').remove();
		
	});
	$('body').on('input', '#anchor_editor input', function () {
		
		if($(this).val().match($(this).prop('pattern'))){
			var id = $(this).data('id') + '';
			var userBlock = _.findWhere(App.userBlocks, {id: id});			
			
			
			userBlock.data.anchor = $(this).val();
			
			$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                        App.events.afterBlockRender(id);
			$('#b_' + id).addClass('change');
		}else{
			
			
		}
	})

	$('body').on('input', '[data-name="video_bg"]', function () {
		
		
		
		var id = $(this).data('settings') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});		
		
		if ($(this).data('type') == 'youtube') {
				userBlock.data[$(this).data('name')] = $(this).val();
		}
		
		// ререндеринг объекта
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		$('#b_' + id).addClass('change');		
		
	})	
	
	$('body').on('input', 'input[data-type="int"]', function () {
		var id = $(this).data('settings') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		if ($(this).data('type') == 'int') {
                    userBlock.data[$(this).data('name')] = parseInt($('.section_config').find('[data-name="'+$(this).data('name')+'"]').val());
		}
		// ререндеринг объекта
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		$('#b_' + id).addClass('change');            
            
        })
	$('body').on('input', 'input[data-type="txt"]', function () {
		var id = $(this).data('settings') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		if ($(this).data('type') == 'txt') {
                    userBlock.data[$(this).data('name')] = $('.section_config').find('[data-name="'+$(this).data('name')+'"]').val();
		}
		// ререндеринг объекта
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		$('#b_' + id).addClass('change');            
            
        })
	
	$('body').on('change, click', '[data-settings]', function () {
		var id = $(this).data('settings') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		// изменяем объект
		if ($(this).data('type') == 'radio') {
			userBlock.data[$(this).data('name')] = $('.section_config').find('[data-name="'+$(this).data('name')+'"]:checked').val();
		}
		if ($(this).data('type') == 'checkbox') {
			if ($(this).prop('checked')) {
                            
                                if($(this).data('name')=='animate' && parseInt(App.t)<3){
                                    alert('Переходите на тариф Grand BIZ или Grand VIP, и функция будет доступна.')
                                    return false;
                                }
                            
				userBlock.data[$(this).data('name')] = 1;
			} else {
				userBlock.data[$(this).data('name')] = 0;
			}
		}
		
		
		if ($(this).data('type') == 'colors') {
			
			$(this).parent().children('.color').removeClass('selected');
			$(this).addClass('selected');
			
			
			userBlock.data[$(this).data('name')] = $(this).data('value');
		}
		if ($(this).data('type') == 'pattern') {
			userBlock.data[$(this).data('name')] = $(this).data('value');
		}
		if ($(this).data('type') == 'background') {
			userBlock.data[$(this).data('name')] = $(this).data('value');
		}
		
		// ререндеринг объекта
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		$('#b_' + id).addClass('change');
	});
	
	$('body').on('click','[data-editor="image_gallery"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});		
		var name= $(this).data('name');
		var html = '';
		
		
		html += '<div class="image_size">Рекомендуемый размер изображения 1920x1000px (*.png/*.jpg) </div>';
		html += '<div><form id="image_gallery_upload" enctype="multipart/form-data" data-id="'+id+'" data-name="'+name+'" data-var-box="" data-var-box-id=""><input type="hidden" name="block_id" value="'+id+'"  /><input type="file" name="image"><input type="submit" value="Загрузить" /></form></div>';
                
                var categories = [
                    {
                        title:'Общее',
                        id:1,
                        range:[
                            {
                                min:1,
                                max:347,
                                exclude: []
                            },
                            {
                                min:1000,
                                max:1064,
                                exclude: []
                            },
                        ]
                    },
                    {
                        title:'Животные',
                        id:2,
                        range:[
                            {
                                min:2000,
                                max:2060,
                                exclude: []
                            },
                        ]
                    },
                    {
                        title:'Сдания и сооружения',
                        id:3,
                        range:[
                            {
                                min:3000,
                                max:3135,
                                exclude: [3049]
                            },
                        ]
                    },
                    {
                        title:'Одежда',
                        id:4,
                        range:[
                            {
                                min:4000,
                                max:4122,
                                exclude: []
                            },
                        ]
                    },
                    {
                        title:'Компьютеры',
                        id:5,
                        range:[
                            {
                                min:5000,
                                max:5168,
                                exclude: []
                            },
                        ]
                    },
                    {
                        title:'Еда',
                        id:6,
                        range:[
                            {
                                min:6000,
                                max:6127,
                                exclude: []
                            },
                        ]
                    },
                    {
                        title:'Интерьер',
                        id:7,
                        range:[
                            {
                                min:7000,
                                max:7360,
                                exclude: [7119]
                            },
                        ]
                    },
                    {
                        title:'Машины',
                        id:8,
                        range:[
                            {
                                min:8000,
                                max:8115,
                                exclude: []
                            },
                        ]
                    },
                    {
                        title:'Природа',
                        id:9,
                        range:[
                            {
                                min:9000,
                                max:9231,
                                exclude: []
                            },
                        ]
                    },
                    {
                        title:'Люди',
                        id:10,
                        range:[
                            {
                                min:10000,
                                max:10480,
                                exclude: [10073]
                            },
                        ]
                    },
                    {
                        title:'Обувь',
                        id:11,
                        range:[
                            {
                                min:11000,
                                max:11061,
                                exclude: [11012]
                            },
                        ]
                    },
                    {
                        title:'Спорт',
                        id:12,
                        range:[
                            {
                                min:12000,
                                max:12142,
                                exclude: []
                            },
                        ]
                    },
                    
                    
                ];
                
                var tabs = '';
                var tabbodys = '';
                
                _.each(categories, function(cat){
                    tabs  += '<div class="imagetab" data-tab="'+cat.id+'">'+cat.title+'</div>';
                    
                    tabbodys  += '<div class="tabimages" data-images="'+cat.id+'">';
                    
                    _.each(cat.range, function(r){
                    
                        for(i=r.min; i<=r.max; i++){
                            if(_.contains(r.exclude, i)){
                                continue;
                            }    

                            tabbodys += '<img src="/img/260x70/image_'+i+'.jpg" data-image="image_'+i+'.jpg" data-image-gallery="picker" data-id="'+id+'" data-name="'+name+'" />';
                        }
                    })
                    
                    tabbodys += '<div class="clear"></div>';
                    
                    tabbodys  += '</div>';
                    
                    
                })
                
		
//		for(i=1; i<=347; i++){
//			html += '<img src="/img/260x70/image_'+i+'.jpg" data-image="image_'+i+'.jpg" data-image-gallery="picker" data-id="'+id+'" data-name="'+name+'" />';
//		}
                
		html += tabs;
		html += tabbodys;
                
		html += '<div class="clear"></div>';
		
		RemoveWindow();
		OpenWindow('Изображение',  html, 'image_gallery_conf');
                
                $('.image_gallery_conf').find('.imagetab').eq(0).click();
                
	})
        
        
	$('body').on('click', '.imagetab', function () {
        
            
            $(this).parent().find('.imagetab').removeClass('current');
            
            $(this).addClass('current');
                    
            $(this).parent().find('.tabimages').hide();
            $(this).parent().find('[data-images="'+$(this).data('tab')+'"]').show();
            
            
        })
        
        
	$('#wrapper').on('click', '.tools_left span', function () {
		var id = $(this).closest('.section').data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var way = $(this).data('way');
		var search = 1;
		
                
                // при перелистывании кешируем данные блока
                    
                if(typeof(App.userBlocksCache)==='undefined'){
                    App.userBlocksCache = [];
                }
                var cache = {};
                $.extend(true, cache, userBlock);
                var cacheBlock = _.findWhere(App.userBlocksCache, {id: id , type_id: userBlock.type_id , position: userBlock.position});


                cache.type_id =  cache.type_id*1;
                cache.position =  userBlock.position;
                
                if(_.isObject(cacheBlock)){
                    $.extend(true, cacheBlock, userBlock);
                }else{
                    App.userBlocksCache.push(cache);
                }

                
                
                
                
                
                
                
		_.each(App.sections, function(object,index){
				_.each(object.blocks, function(o,i){
					if(o.id==userBlock.type_id && o.position==userBlock.position && search){
						var section_group = object.blocks;
						var current_section_type = i;
						var section_len = section_group.length-1;
						var next_type = current_section_type;
                                                
						if(way=='left'){
							next_type--;
							if(next_type<0) next_type= section_len;
							
						}else{
							next_type++;
							if(next_type>section_len) next_type=0;
						}
						
						userBlock.type_id = section_group[next_type].id;
						userBlock.position = section_group[next_type].position;
						userBlock.data = section_group[next_type].default_values;
                                                
                                                console.log(userBlock.data)
						search =0;
						
					}
				})
		})
		

		
		
		var cache2 = _.findWhere(App.userBlocksCache, {id: id , type_id: userBlock.type_id, position: userBlock.position });
		
                if(_.isObject(cache2)){
                    if(way=='left'){
                        $('#b_' + id).find('.tools').hide();
                        $('#b_' + id).find('.tools_left').hide();
                        $('#b_' + id).stop(true,true);
                        $('#b_' + id).animate({left:"-100%"}, 500, function(){
                            $('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, cache2.data, userBlock.position));
                            $('#b_' + id).css({left:"100%"});
                            $('#b_' + id).stop(true,true);
                            $('#b_' + id).animate({left:"0"}, 500,function(){
                                
                                    $('#b_' + id).find('.tools').show();
                                    $('#b_' + id).find('.tools_left').show();
                                
                            });
                            
                            
                        })
                    }else{
                        $('#b_' + id).find('.tools').hide();
                        $('#b_' + id).find('.tools_left').hide();
                        $('#b_' + id).stop(true,true);
                        $('#b_' + id).animate({left:"100%"}, 500, function(){
                            $('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, cache2.data, userBlock.position));
                            $('#b_' + id).css({left:"-100%"});
                            $('#b_' + id).stop(true,true);
                            $('#b_' + id).animate({left:"0"}, 500,function(){
                                
                                    $('#b_' + id).find('.tools').show();
                                    $('#b_' + id).find('.tools_left').show();
                                
                            });
                        })
                    }
                    App.events.afterBlockRender(id);
                }else{
                    if(way=='left'){
                        $('#b_' + id).find('.tools').hide();
                        $('#b_' + id).find('.tools_left').hide();
                        $('#b_' + id).stop(true,true);
                        $('#b_' + id).animate({left:"-100%"}, 500, function(){
                            

//                            var default_values = false;
//                            _.each(App.sections, function(object, index){
//                                if(_.isObject(App.sections[index]['default_values'])){
//                                    if(_.isObject(App.sections[index]['default_values'][userBlock.type_id])){
//                                        default_values = App.sections[index]['default_values'][userBlock.type_id];
//                                    }
//                                }
//                            })                            
                            
                            
                            
                            
                            
                            $('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                            $('#b_' + id).css({left:"100%"});
                            $('#b_' + id).stop(true,true);
                            $('#b_' + id).animate({left:"0"}, 500,function(){
                                
                                    $('#b_' + id).find('.tools').show();
                                    $('#b_' + id).find('.tools_left').show();
                                
                            });
                        })
                    }else{
                        $('#b_' + id).find('.tools').hide();
                        $('#b_' + id).find('.tools_left').hide();
                        $('#b_' + id).stop(true,true);
                        
                        
                        
                        $('#b_' + id).animate({left:"100%"}, 500, function(){
                             $('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data,userBlock.position));
                            $('#b_' + id).css({left:"-100%"});
                            $('#b_' + id).stop(true,true);
                            $('#b_' + id).animate({left:"0"}, 500,function(){
                                
                                    $('#b_' + id).find('.tools').show();
                                    $('#b_' + id).find('.tools_left').show();
                                
                            });
                        })
                    }                    
                    
                    
                    App.events.afterBlockRender(id);
                }
		

		$('#b_' + id).addClass('change');		
	});	
	
	$('body').on('click','[data-image-gallery="picker"]',function(){
		var id = $(this).data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});		
		var name= $(this).data('name');
		
		userBlock.data[name]=$(this).data('image');
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
		$('#b_' + id).addClass('change');		
		
	})
	
	$('body').on('submit', '#image_gallery_upload', function(event){
		event.preventDefault();
		var id = $(this).data('id') + '';
		var name = $(this).data('name');
		var userBlock = _.findWhere(App.userBlocks, {id: id});	
		var data_send = new FormData($(this)[0]);
		$.ajax({dataType: "json", 
			type: "POST", 
			url: "https://tobiz.net/system/editor/upload.php", 
			data: data_send, 
			cache: false, 
			contentType: false, 
			processData: false,
			success: function(data){
				if (data.status == 'OK') {

					userBlock.data[name]= data.image;
					$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                                        App.events.afterBlockRender(id);
					RemoveWindow();		
				} else {
					alert(data.msg);
					
					
					
				}				
			}})
		})	
	
	
	
	// копирование ряда
	$('#wrapper').on('mouseenter', '[data-var-box]', function (e) {
		
		if($(this).data('varBoxType')=='inline'){
			if ($(this).data('varBoxId') > 0) {
				$(this).append('<div class="remove_var_box_linline"><i class="fa fa-trash"></i></div>');
				$(this).append('<div class="add_var_box_inline"><i class="fa fa-plus"></i></div>');
			}else{
				$(this).append('<div class="add_var_box_inline"><i class="fa fa-plus"></i></div>');
				
			}
			
		}else{
			if ($(this).data('varBoxId') > 0) {
				$(this).append('<div class="add_var_box"><div class="panel"><i class="fa fa-plus"></i><i class="fa fa-trash"></i></div></div>');
			} else {
				$(this).append('<div class="add_var_box"><div class="panel"><i class="fa fa-plus"></i></div></div>');
			}
		}
		
		
	});
	$('#wrapper').on('mouseleave', '[data-var-box]', function (e) {
		$(this).children('.add_var_box').remove();
		$(this).closest('.section_inner').find('.remove_var_box_linline').remove()
		$(this).closest('.section_inner').find('.add_var_box_inline	').remove()
		
		
	});
	$('#wrapper').on('mouseenter', '.add_var_box .panel i', function (e) {
		$(this).parent().parent().parent().addClass('hover');
	})
	$('#wrapper').on('mouseleave', '.add_var_box .panel i', function (e) {
		$(this).parent().parent().parent().removeClass('hover');
	})
	$('#wrapper').on('click', '.add_var_box .panel i.fa-plus', function () {
		var id = $(this).closest('.section').data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
                
                
		var var_box_name = $(this).parent().parent().parent().data('varBox');
		var var_box_id = $(this).parent().parent().parent().data('varBoxId');
		if(userBlock.type_id==301){ // KOSTIL
                    var object_to_push = _.cloneDeep(userBlock.data[var_box_name][var_box_id]);
                    userBlock.data[var_box_name]=userBlock.data[var_box_name].reverse();
                    userBlock.data[var_box_name].push(object_to_push);
                    userBlock.data[var_box_name]=userBlock.data[var_box_name].reverse();
                    
                }else{
                    userBlock.data[var_box_name].push(_.cloneDeep(userBlock.data[var_box_name][var_box_id]));
                }
		
            
                $('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	
	$('#wrapper').on('click', '.add_var_box_inline', function (e) {
		e.stopPropagation();
		var id = $(this).closest('.section').data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
		userBlock.data[var_box_name].push(_.cloneDeep(userBlock.data[var_box_name][var_box_id]));
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	
	
	$('#wrapper').on('click', '.add_var_box .panel i.fa-trash', function () {
		var id = $(this).closest('.section').data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var var_box_name = $(this).parent().parent().parent().data('varBox');
		var var_box_id = $(this).parent().parent().parent().data('varBoxId');
		userBlock.data[var_box_name].splice(var_box_id, 1);
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})
	$('#wrapper').on('click', '.remove_var_box_linline', function (e) {
		e.stopPropagation();
		var id = $(this).closest('.section').data('id') + '';
		var userBlock = _.findWhere(App.userBlocks, {id: id});
		var var_box_name = $(this).closest('[data-var-box]').data('varBox');
		var var_box_id = $(this).closest('[data-var-box-id]').data('varBoxId');
		userBlock.data[var_box_name].splice(var_box_id, 1);
		$('#b_' + id).replaceWith(render(userBlock.type_id, userBlock.id, userBlock.data, userBlock.position));
                App.events.afterBlockRender(id);
	})

	// Добавление секции.
	$('#add_section').click(function () {
		var add_section_html = '';
		$.each(App.sections, function (index) {
			if(!App.sections[index].invisible && App.sections[index].widget==0){
				add_section_html += '<div class="section_link" data-group="' + index + '"><i class="' + App.sections[index].icon + '"></i>' + App.sections[index].name + '</div>';
			}
		})
		OpenWindow('Добавить секцию', add_section_html, 'add_section');
	});
	$('body').on('click', '.section_link', function () {
		if (App.sections[$(this).data('group')].blocks[0]) {
			$('#wrapper').append(render(App.sections[$(this).data('group')].blocks[0]['id'], false, App.sections[$(this).data('group')].blocks[0]['default_values'], App.sections[$(this).data('group')].blocks[0]['position']));
                        RemoveWindow();
			setTimeout(function(){
				if($('.section').size()){
					var destination = $('.section').eq($('.section').length-1).offset().top - 60;	
					$('body, html').animate({ scrollTop: destination }, 1100);
				}
			},300)
		} else {
			alert('Ошибка!');
			RemoveWindow();
		}
	})
	
	// Добавление виджета. add_widgets
	$('#add_widgets').click(function () {
            
            if(App.t<=2){
                OpenWindow('Доступ ограничен', 'Виджеты можно подключить только на тарифах линейки Grand. <a href="https://tobiz.net/price/" target="_blank">Перейти</a> ?', 'add_widgets_block');
                return false;
            }
            
            
            var add_widgets_html = '';
            $.each(App.sections, function (index) {
                if(!App.sections[index].invisible && App.sections[index].widget==1){
                    add_widgets_html += '<div class="section_link" data-group="' +   index + '"><i class="' + App.sections[index].icon + '"></i>' + App.sections[index].name + '</div>';
                }
            })
            OpenWindow('Добавить виджет', add_widgets_html, 'add_widgets');
	});

	
	//сохранение страницы.
	$('#save').click(function () {
		$('.section').each(function(i){
			var id = $(this).attr('id');
			id = id.substr(2);
			var userBlock = _.findWhere(App.userBlocks, {id: id});
			userBlock.sort_id = i
			userBlock.cache = renderCache(userBlock);
		})
		$.ajax({
			data: {action: 'SaveBlocks', data: JSON.stringify(App)},
			success: function (data) {
				if (data.status == 'OK') {
					
					$('.alert_save').remove();
					
					
					var alert_id = 'alert_save_'+ Math.floor(Math.random() * (99999 - 10000 + 1)) + 10000;
					$('body').append('<div class="alert_save" id="'+alert_id+'">Сохранено. (Ctrl+S)</div>');
					$('#'+alert_id).fadeIn();
					setTimeout(function(){
						$('#'+alert_id).fadeOut(function(){
							$('#'+alert_id).remove();
						});
					},3000);
					$('.section').removeClass('change');
				} else {
					
				}
			}
		})
	});
	$(window).keypress(function (event) { // Ctrl+S
		if (!(event.which == 115 && event.ctrlKey) && !(event.which == 19))
			return true;
		$('#save').click();
		event.preventDefault();
		return false;
	});
	$(window).keydown(function (event) {
		if (event.keyCode == 27){
			RemoveWindow();
			
		}
			
	});
	
	
	
	// Подтверждение на выход.
	setInterval(function () {
		if ($('.section.change').size()) {
			window.onbeforeunload = function () {
				return 'Эта страница просит вас подтвердить, что вы хотите уйти — при этом введённые вами данные могут не сохраниться.'
			};
		} else {
			window.onbeforeunload = null;
		}
	}, 100)
	
	// мелочи.
	$('#exit').click(function () {
		window.location.href = 'https://tobiz.net/projects/';
	})
        
        $('body').on('click', '#window .conf_item .spoiler-title', function(){
            $(this).parent().find('.spoiler-content').toggle();
            
        })
	
	
	App.introEventListener = function(){
		
                $('body').on('click','a.btn1, a.btn2, a.btn3, a.btn4, a.btn5',function(e){
                    e.preventDefault()
                })
                $('body').on('click', '.link_editor_false', function(e){
                    
                    e.preventDefault();
                    
                })                
		
                
                
		
		
		
	}
	App.introEventListener();

	
	

	
	
	

})